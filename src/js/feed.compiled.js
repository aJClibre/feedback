var $jscomp={scope:{},findInternal:function(a,g,d){a instanceof String&&(a=String(a));for(var l=a.length,b=0;b<l;b++){var m=a[b];if(g.call(d,m,b,a))return{i:b,v:m}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,g,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[g]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,g,d,l){if(g){d=$jscomp.global;a=a.split(".");for(l=0;l<a.length-1;l++){var b=a[l];b in d||(d[b]={});d=d[b]}a=a[a.length-1];l=d[a];g=g(l);g!=l&&null!=g&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:g})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6-impl","es3");var feed=function(){return{initModule:function(a,g,d){a=$("#"+a);d=d?d:null;feed.model.initModule();feed.shell.initModule(a,g,d)}}}();feed.util=function(){var a;a=function(a,d,l){var b=Error();b.name=a;b.message=d;l&&(b.data=l);return b};return{makeError:a,setConfigMap:function(g){var d=g.input_map,l=g.settable_map;g=g.config_map;for(var b in d)if(d.hasOwnProperty(b))if(l.hasOwnProperty(b))g[b]=d[b];else throw d=a("Bad Input","Setting config key |"+b+"| is not supported"),d;}}}();feed.data=function(){return{}}();feed.fake=function(){var a,g,d,l;a=[];g={admin:{list_:!0,create_:!0,read_:!0,update_:!0,delete_:!0},view:{list_:!0,create_:!1,read_:!1,update_:!1,delete_:!1}};d=function(){var b={};return{emit:function(m,f){var d;"adduser"===m&&b.userupdate&&setTimeout(function(){d={_id:f.cid,rule:f.rule,rules_map:g[f.rule]};a.push(d);b.userupdate([d])},10)},on:function(a,f){b[a]=f}}}();l=function(){var a={};return{emit:function(b,f){"createreport"===b&&a.listchange?(console.dir(f),$.post("../feed/",f,function(b){a.listchange([b,
f])},"json")):"updatereport"===b&&a.listchange?(console.dir(f),$.post("../feed/",f).done(function(b){a.listchange([b])},"json")):"uploadreport"===b&&a.listchange?f.submit():"deletedoc"===b&&a.listchange?$.get("../feed/",{id:f,doc:!0}).done(function(b){a.listchange([b])},"json"):"deletereport"===b&&a.listchange?$.get("../feed/",{id:f}).done(function(b){console.dir(b);a.listchange([b])},"json"):"getreports"===b&&a.listchange?$.get("../feed/",function(b){console.dir(b);a.listchange([b])},"json"):"downloadreports"===
b&&(window.location.href="../feed/csv/?ids="+f.list.toString())},on:function(b,f){a[b]=f}}}();return{mockSio:d,mockSioReport:l}}();feed.model=function(){var a={anon_id:"a0",anon_rules_map:{list_:!0,read_:!1,create_:!1,update_:!1,upload:!1,delete_doc_:!1,delete_:!1},anon_rule:"anonymous",empty_id:"e0",empty_title:"",empty_textarea:"",empty_statu:"",empty_type_r:"",empty_type_e:"",empty_created:"",empty_modified:"",empty_owner:"",empty_history:"",empty_locate_map:{x:0,y:0}},g=null,d=0,l=0,b={},m=TAFFY(),f=null,p=null,q={},k=TAFFY(),h=null,x,w,y,t,n,u,A,B,F,G,C,E,z;x={get_is_user:function(){return this.cid===f.cid},get_is_anon:function(){return this.cid===
g.cid}};w=function(){return"c"+String(d++)};y=function(){var a=f;m=TAFFY();b={};a&&(m.insert(a),b[a.cid]=a)};t=function(a){a=a[0];delete b[a.cid];f.cid=a._id;f.id=a._id;f.rule=a.rule;f.rules_map=a.rules_map;b[a._id]=f;z.get_list();$.gevent.publish("feed-login",[f])};n=function(a){var c=a.cid,r=a.id,v=a.rules_map,e=a.rule;if(void 0===c||!e)throw"makePerson exception : client id required";a=Object.create(x);a.cid=c;a.rule=e;a.rules_map=v;r&&(a.id=r);b[c]=a;m.insert(a);return a};u=function(){return{get_by_cid:function(a){return b[a]},
get_db:function(){return m},get_user:function(){return f},login:function(a){var c=feed.fake.mockSio;f=n({cid:w(),rule:a});c.on("userupdate",t);c.emit("adduser",{cid:f.cid,rule:f.rule})},logout:function(){var a=f;z._leave();f=g;y();$.gevent.publish("feed-logout",[a])}}}();A={get_is_report:function(){return this.cid===h.cid},get_is_empty:function(){return this.cid===a.empty_id}};B=function(){return"c"+String(l++)};F=function(){k=TAFFY();q={}};G=function(a){};C=function(a){var c=a.cid,b=a.id,v=a.id_equi,
e=a.textarea,f=a.statu,g=a.type_r,h=a.type_e,d=a.action,l=a.cible,m=a.history_status,y=a.created,t=a.modified,n=a.owner,H=a.locate_map,p=a.doc;if(void 0===c)throw"report id required";a=Object.create(A);a.cid=c;a.id_equi=v;a.textarea=e;a.statu=f;a.type_r=g;a.type_e=h;a.action=d;a.cible=l;a.history_status=m;a.locate_map=H;a.created=y;a.modified=t;a.owner=n;a.doc=p;b&&(a.id=b);q[c]=a;k.insert(a);return a};E=function(){return{get_by_cid:function(a){return q[a]},get_db:function(){return k},get_current:function(){return h},
create_:function(a){var c;if(f.get_is_anon())return console.warn("D\u00e9sol\u00e9, vous devez vous connecter !"),!1;c=feed.fake.mockSioReport;c.on("addreport",G);console.log("createreport report_create_map.id_equi: "+a.id_equi);c.emit("createreport",{cid:B(),locate_map:a.locate_map,id_equi:a.id_equi,textarea:a.textarea,statu:a.statu,type_r:a.type_r,type_e:a.type_e,doc:a.doc})},delete_:function(a){var c=feed.fake.mockSioReport;c&&c.emit("deletereport",a)},update_:function(a){var c=feed.fake.mockSioReport;
c&&c.emit("updatereport",a)},upload_:function(a){var c=feed.fake.mockSioReport;c&&c.emit("uploadreport",a)},delete_doc_:function(a){var c=feed.fake.mockSioReport;c&&c.emit("deletedoc",a)},cancel_:function(a){h.id===a&&$.gevent.publish("feed-setreport",{old_report:h,new_report:h})}}}();z=function(){var a,c,b;c=function(a){var e,c=a[0].data?a[0].data:[];e=a[0].user;var v=a[0].message?a[0].message:null,r=!1,g=!1;e&&(f.email=e.email,f.admins=e.admins);console.dir(a);F();1<a.length&&(v?$.gevent.publish("feed-alert",
{text:v,type:"danger"}):(e=a[1],delete q[e.cid],h.cid=e._id,h.id=e._id,h.id_equi=e.id_equi,h.textarea=e.textarea,h.statu=e.statu,h.type_r=e.type_r,h.type_e=e.type_e,h.action=e.action,h.cible=e.cible,h.created=e.created,h.modified=e.modified,h.owner=e.owner,h.history_status=e.history_status,h.locate_map=e.locate_map,h.doc=e.doc,r=g=!0,console.log("_update_reports_list before publish"),$.gevent.publish("feed-alert",{text:"Le rapport a \u00e9t\u00e9 cr\u00e9\u00e9 avec succ\u00e8s !",type:"primary"}),
console.log("_update_reports_list after publish")));a=0;a:for(;a<c.length;a++){e=c[a];h.get_is_empty()||h.id!==e._id||(g||v?$.gevent.publish("feed-alert",{text:v,type:"danger"}):($.gevent.publish("feed-alert",{text:"La mise \u00e0 jour a \u00e9t\u00e9 r\u00e9alis\u00e9e avec succ\u00e8s !",type:"primary"}),h.id_equi=e.id_equi,h.textarea=e.textarea,h.statu=e.statu,h.type_r=e.type_r,h.type_e=e.type_e,h.action=e.action,h.cible=e.cible,h.created=e.created,h.modified=e.modified,h.owner=e.owner,h.history_status=
e.history_status,h.locate_map=e.locate_map,h.doc=e.doc),$.gevent.publish("feed-setreport",{old_report:h,new_report:h}),r=!0);if(e&&!e._id)continue a;e={cid:e._id,locate_map:e.locate_map,id:e._id,id_equi:e.id_equi,textarea:e.textarea,statu:e.statu,type_r:e.type_r,type_e:e.type_e,action:e.action,cible:e.cible,created:e.created,modified:e.modified,owner:e.owner,history_status:e.history_status,doc:e.doc};C(e)}k.sort("id");r||(h.get_is_empty()?$.gevent.publish("feed-alert",{text:"La mise \u00e0 jour a \u00e9t\u00e9 r\u00e9alis\u00e9e avec succ\u00e8s !",
type:"primary"}):($.gevent.publish("feed-alert",{text:"Le rapport a \u00e9t\u00e9 supprim\u00e9 avec succ\u00e8s !",type:"primary"}),b("")))};a=function(a){c(a);$.gevent.publish("feed-listchange",[a[0].data])};b=function(a){if(a=q[a]){if(h&&h.id===a.id)return!1}else a=p;$.gevent.publish("feed-setreport",{old_report:h,new_report:a});h=a;return!0};return{_leave:function(){var a=feed.fake.mockSioReport;a&&a.emit("leavelist")},get_report:function(){return h},get_list:function(){var c;if(f.get_is_anon())return $.gevent.publish("feed-alert",
{text:"D\u00e9sol\u00e9, vous devez vous connecter avant !",type:"warning"}),!1;c=feed.fake.mockSioReport;c.on("listchange",a);c.emit("getreports",{user:f});return!0},update_list:function(c){a(c)},down_list:function(a){if(f.get_is_anon())return $.gevent.publish("feed-alert",{text:"D\u00e9sol\u00e9, vous devez vous connecter avant !",type:"warning"}),!1;feed.fake.mockSioReport.emit("downloadreports",{list:a});return!0},set_report:b}}();return{initModule:function(){f=g=n({cid:a.anon_id,id:a.anon_id,
rules_map:a.anon_rules_map,rule:a.anon_rule});h=p=C({cid:a.empty_id,id:a.empty_id,id_equi:a.empty_title,textarea:a.empty_textarea,statu:a.empty_statu,type_r:a.empty_type_r,type_e:a.empty_type_e,action:a.empty_action,cible:a.empty_cible,created:a.empty_created,modified:a.empty_modified,owner:a.empty_owner,locate_map:a.empty_locate,history_status:a.empty_history})},people:u,reports:E,sidebar:z,map:{}}}();feed.util_b=function(){var a=/[&"'><]/g,g=/["'><]/g,d={"&":"&#38;",'"':"&#34;","'":"&#39;",">":"&#62;","<":"&#60;"},l={ATTENTE:"En attente",COURS:"En cours",TRAITE:"Trait&eacute;",REJETE:"Rejet&eacute;",PROBLEME:"Un dysfonctionnement concernant un &eacute;quipement",ERREUR:"Une erreur sur la cartographie",INFO:"Information",CREATION:"Cr&eacute;ation",MODIF:"Modification",DEPLACE:"D&eacute;placement",SUPRIME:"Suppression",SDIS:"SDIS",BMPM:"BMPM",ONF:"ONF",DDTM:"DDTM",DFCI:"Commission DFCI",CD:"CD",
AUTRE:"Autre..."},b;b=$.extend({},d);delete b["&"];return{decodeHtml:function(a){return $("<div/>").html(a||"").text()},encodeHtml:function(l,f){var m=String(l),q,k;f?(k=b,q=g):(k=d,q=a);return m.replace(q,function(a,b){return k[a]||""})},coordWgs84ToL93:function(a,b){var f=new OpenLayers.Projection("EPSG:900913"),g=new OpenLayers.Projection("EPSG:2154"),k=new OpenLayers.Geometry.Point(a,b);k.transform(f,g);return k},coordL93ToWgs84:function(a,b){var f=new OpenLayers.Projection("EPSG:2154"),g=new OpenLayers.Projection("EPSG:900913"),
k=new OpenLayers.Geometry.Point(a,b);k.transform(f,g);return k},toLiterary:function(a){var b=String(a);return(a=l[b])?a:b},getEmSize:function(a){return Number(getComputedStyle(a,"").fontSize.match(/\d*\.?\d*/)[0])}}}();feed.shell=function(){var a={sidebar:{opened:!0,closed:!0},tab:{home:!0,report:!0,create:!0,settings:!0}},g={anchor_map:{}},d,l,b,m,f,p,q,k,h,x,w;b=function(){return $.extend(!0,{},g.anchor_map)};m=function(){var a=g.$container;d=a;l=a.find(".feed-shell-acct");a.find(".feed-shell-nav")};w=function(a){var f=b(),k=!0,h,d;a:for(h in a)if(a.hasOwnProperty(h)){if(0===h.indexOf("_"))continue a;f[h]=a[h];d="_"+h;a[d]?f[d]=a[d]:(delete f[d],delete f["_s"+d])}try{$.uriAnchor.setAnchor(f)}catch(B){$.uriAnchor.setAnchor(g.anchor_map,
null,!0),k=!1}return k};f=function(a){var f;a=!0;var k=b();try{f=$.uriAnchor.makeAnchorMap()}catch(u){return $.uriAnchor.setAnchor(k,null,!0),!1}g.anchor_map=f;switch(f.sidebar){case "opened":a=feed.sidebar.setSliderPosition("opened",f.tab);feed.map.setMarkerPosition("opened",f.tab);break;case "closed":a=feed.sidebar.setSliderPosition("closed",f.tab);feed.map.setMarkerPosition("closed",f.tab);break;default:feed.sidebar.setSliderPosition("closed",f.tab),delete f.sidebar}a||(k?($.uriAnchor.setAnchor(k,
null,!0),g.anchor_map=k):(delete f.sidebar,$.uriAnchor.setAnchor(f,null,!0)));return!1};p=function(a){feed.model.people.get_user().get_is_anon()?(a=prompt("Please sign-in"),feed.model.people.login(a),l.text("... processing ...")):feed.model.people.logout();return!1};q=function(a,b){l.text(b.name)};k=function(a,b){l.text("Please sign-in")};h=function(a){return w(a)};x=function(a){return w(a)};return{initModule:function(b,t,n){var u="doc/";g.$container=b;m();$.uriAnchor.configModule({schema_map:a});
t._leaflet_id||(u="/media/doc/");feed.sidebar.configModule({set_sidebar_anchor:h,sidebar_model:feed.model.sidebar,people_model:feed.model.people,reports_model:feed.model.reports,doc_path:u});feed.sidebar.initModule(d);feed.map.configModule({set_map_anchor:x,map_model:feed.model.map,people_model:feed.model.people,reports_model:feed.model.reports,doc_path:u});feed.map.initModule(t);$(window).bind("hashchange",f).trigger("hashchange");$.gevent.subscribe(b,"feed-login",q);$.gevent.subscribe(b,"feed-logout",
k);l.text("Please sign-in").bind("utap",p);console.log("Direct login into the application!");n&&feed.model.people.login(n)}}}();feed.sidebar=function(){var a={main_html:String()+'<div id="sidebar" class="sidebar collapsed" style="font-size:12px;"><ul class="sidebar-tabs" role="tablist"><li id="t_home" class="tab" title="Liste"><a href="#" role="tab"><i class="fa fa-bars" aria-hidden="true"></i></a></li><li id="t_report" class="tab" title="Modifier"><a href="#" role="tab"><i class="fa fa-gear" aria-hidden="true"></i></a></li><li id="t_create" class="tab" title="Cr&eacute;er"><a href="#" role="tab"><i class="fa fa-plus" aria-hidden="true"></i></a></li><li id="t_settings" class="tab" title="Aide"><a href="#" role="tab"><i class="fa fa-info" aria-hidden="true"></i></a></li></ul><div class="sidebar-content feed-sidebar-content active"><div class="sidebar-pane feed-sidebar-content-home active" id="home"><h1>Liste des rapports</h1><div class="feed-sidebar-content-home-box"></div><div class="feed-sidebar-content-home-buttons"><button type="update" class="btn btn-primary btn-sm list-refresh" title="mettre la liste &agrave; jour">Rafraichir</button><a type="button" class="btn btn-primary btn-sm list-download" title="T&eacute;l&eacute;charger la liste au format csv">T&eacute;l&eacute;charger</a></div></div><div class="sidebar-pane feed-sidebar-content-report" id="report"><h1>Rapport &agrave; modifier</h1><h4 class="bg-danger is_selected">Veuillez s\u00e9lectionner un rapport dans la liste</h4><form class="feed-sidebar-content-report-form" id="form_modify"><div class="form-group feed-sidebar-content-report-form-group-head"><h5><label class="col-md-4 control-label">Rapport </label><label class="col-md-7 control-label feed-sidebar-content-report-form-id"> - </label></h5><label class="col-md-2 control-label">Cr\u00e9ation: </label><div class="col-md-4"><p class="form-control-static feed-sidebar-content-report-form-datecreate"></p></div><label class="col-md-3 control-label">Modification: </label><div class="col-md-3"><p class="form-control-static feed-sidebar-content-report-form-datemodif"></p></div><label class="col-md-2 control-label">Auteur: </label><div class="col-md-10"><p class="feed-sidebar-content-report-form-autor"></p></div></div><div class="form-group"><label class="col-md-12 control-label form-label-priority">Statut</label><select class="form-control feed-sidebar-content-report-form-statu"><option value="ATTENTE">'+
feed.util_b.toLiterary("ATTENTE")+'</option><option value="COURS">'+feed.util_b.toLiterary("COURS")+'</option><option value="TRAITE">'+feed.util_b.toLiterary("TRAITE")+'</option><option value="REJETE">'+feed.util_b.toLiterary("REJETE")+'</option></select></div><div class="form-group"><label class="col-md-12 control-label form-label-type_r">Type de rapport</label><select class="form-control feed-sidebar-content-report-form-type_r" data-validation="required"><option value="" disabled selected hidden>Vous souhaitez signaler ...</option><option value="PROBLEME">'+
feed.util_b.toLiterary("PROBLEME")+'</option><option value="ERREUR">'+feed.util_b.toLiterary("ERREUR")+'</option></select></div><div class="form-group"><label class="col-md-12 control-label form-label-type_e">Type d\'&eacute;quipement</label><input type="text" class="form-control form-type_e feed-sidebar-content-report-form-type_e required" id="type_e" placeholder="Ex: piste, citerne, PBI, route, b&acirc;timent, barri&egrave;re..." data-validation="required" >\x3c!-- <p class="help-block">In addition to freeform text, any HTML5 text-based input appears like so.</p> --\x3e</div><div class="form-group"><label class="col-md-12 control-label form-label-id_equi">Identifiant de l\'&eacute;quipement</label><input type="text" class="form-control form-id_equi feed-sidebar-content-report-form-id_equi required" id="id_equi" placeholder="Ex: AL 123" data-validation="required" ></div><div class="form-group"><label for="report-textarea" class="col-md-12 control-label form-label-description">Description</label><textarea id="report-textarea" class="form-control feed-sidebar-content-report-form-textarea" rows="3"></textarea></div><div id="feed-sidebar-content-report-statusdiv"><table id="feed-sidebar-content-report-statushistory" class="table table-condensed table-striped" cellspacing="0" width="100%" role="grid" style="width: 100%;"><thead><tr><th class="control-label"><b>Statut</b></th><th><b>Date</b></th><th><b>Auteur</b></th></tr></thead><tbody></tbody></table></div><div class="form-group feed-sidebar-content-report-group-loc"><label class="col-md-12 control-label form-label-localisation">Localisation (Lambert 93)</label><input type="text" class="col-md-5 feed-sidebar-content-report-form-x" id="x" placeholder="Longitude" readonly><input type="text" class="col-md-5 col-md-offset-2 feed-sidebar-content-report-form-y" id="y" placeholder="Latitude" readonly></div><div class="form-group form-group-action"><label class="col-md-12 control-label form-label-action">Action</label><select class="form-control feed-sidebar-content-report-form-action"><option value="INFO">'+
feed.util_b.toLiterary("INFO")+'</option><option value="CREATION">'+feed.util_b.toLiterary("CREATION")+'</option><option value="MODIF">'+feed.util_b.toLiterary("MODIF")+'</option><option value="DEPLACE">'+feed.util_b.toLiterary("DEPLACE")+'</option><option value="SUPRIME">'+feed.util_b.toLiterary("SUPRIME")+'</option></select></div><div class="form-group form-group-cible"><label class="col-md-12 control-label form-label-cible">Cible</label><select class="form-control feed-sidebar-content-report-form-cible"><option value="SDIS">'+
feed.util_b.toLiterary("SDIS")+'</option><option value="BMPM">'+feed.util_b.toLiterary("BMPM")+'</option><option value="ONF">'+feed.util_b.toLiterary("ONF")+'</option><option value="DDTM">'+feed.util_b.toLiterary("DDTM")+'</option><option value="DFCI">'+feed.util_b.toLiterary("DFCI")+'</option><option value="CD">'+feed.util_b.toLiterary("CD")+'</option><option value="AUTRE">'+feed.util_b.toLiterary("AUTRE")+'</option></select></div><div class="form-group"><a class="btn btn-primary btn-sm report-send">Transmettre</a><button class="btn btn-primary btn-sm report-modify">Modifier</button><button class="btn btn-primary btn-sm report-cancel">Annuler</button></div></form><div class="form-group"><label class="control-label feed-sidebar-content-report-form-doc-label"></label><span class="glyphicon glyphicon-remove g-delete feed-sidebar-content-report-form-group-doc-delete" aria-hidden="true"></span></div><div class="form-group feed-sidebar-content-report-form-group-doc-create"><p class="help-block">Ajouter un fichier: </p><span class="btn btn-primary btn-sm fileinput-button"><i class="glyphicon glyphicon-plus"></i><span>S&eacute;lectionnez un fichier...</span><input id="fileupload" type="file" name="files[]" data-url="../feed/"></input></span><div id="result"></div><button class="btn btn-primary btn-sm fileinput-upload" /><div id="progress"><div class="bar" style="width: 0%;"></div></div></div></div><div class="sidebar-pane feed-sidebar-content-create" id="create"><h1>Cr&eacute;er un rapport</h1><form class="feed-sidebar-content-create-form" id="form_create" name="create_form"><div class="form-group"><label class="col-md-12 control-label form-label-type_r">Type de rapport</label><select class="form-control feed-sidebar-content-create-form-type_r required" data-validation="required"><option value="" disabled selected hidden>Vous souhaitez signalez ...</option><option value="PROBLEME">'+
feed.util_b.toLiterary("PROBLEME")+'</option><option value="ERREUR">'+feed.util_b.toLiterary("ERREUR")+'</option></select></div><div class="form-group"><label class="col-md-12 control-label form-label-type_e">Type d\'&eacute;quipement</label><input type="text" class="form-control form-type_e feed-sidebar-content-create-form-type_e required" id="type_e" placeholder="Ex: piste, citerne, PBI, route, b&acirc;timent, barri&egrave;re..." data-validation="required" >\x3c!-- <p class="help-block">In addition to freeform text, any HTML5 text-based input appears like so.</p> --\x3e</div><div class="form-group"><label class="col-md-12 control-label form-label-id_equi">Identifiant de l\'&eacute;quipement</label><input type="text" class="form-control form-id_equi feed-sidebar-content-create-form-id_equi required" id="id_equi" placeholder="Ex: AL 123" data-validation="required" ></div><div class="form-group"><label for="create-textarea" class="col-md-12 control-label form-label-description">Description</label><textarea id="create-textarea" class="form-control feed-sidebar-content-create-form-textarea" rows="3" placeholder="Veuillez pr\u00e9ciser l\'anomalie rencontr\u00e9e"></textarea></div><div class="form-group feed-sidebar-content-create-group-locate"><label class="col-md-12 control-label form-label-localisation">Localisation (Lambert 93)</label><p class="help-block">D\u00e9placez la carte pour modifier la localisation du rapport.</p><input type="text" class="col-md-5 feed-sidebar-content-create-form-x" id="xCreate" placeholder="Longitude" readonly data-validation="required" ><input type="text" class="col-md-5 col-md-offset-2 feed-sidebar-content-create-form-y" id="yCreate" placeholder="Latitude" readonly data-validation="required" ></div><div class="form-group"><button class="btn btn-primary btn-sm report-create">Cr&eacute;er</button><button type="reset" class="btn btn-primary btn-sm reset">Annuler</button></div></form></div><div class="sidebar-pane" id="settings"><h1>L\'application en quelques mots...</h1><p>Chaque rapport cr&eacute;&eacute; est consultable par tous les autres utilisateurs de l\'application.</p><p>Un rapport est modifiable par son cr&eacute; tant que son statut est &laquo; en attente &raquo;.</p><p>L\'administrateur de l\'application consigne et signale aux gestionnaires concern&eacute;s l\'information contenue dans le rapport afin de proc&eacute;der aux correctifs &agrave; apporter.</p><p>L\'\u00e9tat d\'avancement du traitement de l\'information est actualis&eacute; en temps r&eacute;el par l\'administrateur au moyen d\'un jeu de couleurs:<ul style="list-style-type:none"><li>- <span class="feed-sidebar-content-list-td-statu-attente"><b>rouge</b></span>: en attente</li><li>- <span class="feed-sidebar-content-list-td-statu-cours"><b>Jaune</b></span>: en cours de traitement</li><li>- <span class="feed-sidebar-content-list-td-statu-traite"><b>Vert</b></span>: trait&eacute;</li><li>- <span class="feed-sidebar-content-list-td-statu-rejete"><b>Gris</b></span>: rejet&eacute;</li></ul></p><p>Les &eacute;l&eacute;ments &laquo; trait&eacute;s &raquo; seront int&eacute;gr&eacute;s &agrave; la cartographie au moment de la mise &agrave; jour, pour le moment annuelle, du site.</p><p>L\'administrateur est &agrave; votre disposition &agrave; l\'adresse: <a href="mailto:#" class="feed-sidebar-content-help-email">contact.admin13@valabre.com</a></p></div></div><div class="modal fade feed-sidebar-modal-img" id="modalImg" tabindex="-1" role="dialog" aria-labelledby="modal-img-title">  <div class="modal-dialog modal-lg" role="document">   <div class="modal-content">     <div class="modal-body">         <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>         <h4 class="feed-sidebar-modal-img-title" id="modal-img-title"></h4>         <img class="img img-responsive img-thumbnail feed-sidebar-modal-img-body-img center-block" alt="No image" src="">     </div>   </div> </div></div><div class="modal fade feed-sidebar-modal-message" id="modalMess" tabindex="-1" role="dialog" data-backdrop="false" aria-labelledby="modal-img-title">  <div class="modal-dialog" role="document">   <div class="modal-content">     <div class="modal-header feed-sidebar-modal-message-header bg-primary">         <h4 class="feed-sidebar-modal-message-title" id="modalMessTitle">Message</h4>     </div>     <div class="bg-default modal-body">         <strong><p class="feed-sidebar-modal-message-body-p"></p></strong>     </div>   </div> </div></div></div>\x3c!-- http://formvalidator.net/index.html --\x3e <script>$.validate({language : {requiredFields: "Champ obligatoire."}});\x3c/script>',
settable_map:{sidebar_model:!0,people_model:!0,reports_model:!0,set_sidebar_anchor:!0,doc_path:!0},sidebar_model:null,people_model:null,reports_model:null,set_content_anchor:null},g=null,d="closed",l=null,b=null,m="bg-primary",f,p,q,k,h,x,w,y,t,n,u,A,B,F,G,C,E,z,H,c,r,v,e,O,D,P,I,ja,Q,X,R,S,Y,T,Z,ka,la,K,U,aa,ba,ma,na,ca,J,oa,pa,da,ea,fa,qa,ra,ga,sa,L,M,V,ta,N,W,ha,ua,va,wa,xa,ya,za,Aa,Ba,Ca,ia,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa;ga=function(){var a=[];$("#tableReports").find("tr").each(function(Qa){$(this).attr("tr-id")&&
a.push($(this).attr("tr-id"))});return a};sa=function(){var a=g.find(".sidebar");f=a;p=a.find(".tab");q=a.children(".sidebar-content").first();k=a.find(".feed-sidebar-content-home-box");h=a.find(".feed-sidebar-content-report-form");x=a.find(".feed-sidebar-content-report-form .form-group");w=a.find(".feed-sidebar-content-report-form-id");y=a.find(".feed-sidebar-content-report-form-id_equi");t=a.find(".feed-sidebar-content-report-form-textarea");n=a.find(".feed-sidebar-content-report-form-statu");u=
a.find(".feed-sidebar-content-report-form-type_r");A=a.find(".feed-sidebar-content-report-form-type_e");B=a.find(".feed-sidebar-content-report-form-action");F=a.find(".form-group-cible");G=a.find(".form-group-action");C=a.find(".feed-sidebar-content-report-form-cible");E=a.find(".feed-sidebar-content-report-form-datecreate");z=a.find(".feed-sidebar-content-report-form-datemodif");H=a.find(".feed-sidebar-content-report-form-autor");c=a.find("#feed-sidebar-content-report-statusdiv");r=a.find("#feed-sidebar-content-report-statushistory");
v=a.find(".feed-sidebar-content-report-form-x");e=a.find(".feed-sidebar-content-report-form-y");O=a.find(".feed-sidebar-content-report-form-doc-label");D=a.find(".feed-sidebar-content-report-form-group-doc-create");P=a.find(".feed-sidebar-content-report-form-file");I=a.find(".feed-sidebar-content-report-form-group-doc-delete");ja=a.find("#fileupload");Q=a.find(".fileinput-upload");X=a.find("#progress .bar");R=a.find(".feed-sidebar-content-create-form");a.find(".feed-sidebar-content-create-form .form-group");
S=a.find(".feed-sidebar-content-create-form-id_equi");Y=a.find(".feed-sidebar-content-create-form-textarea");T=a.find(".feed-sidebar-content-create-form-type_r");Z=a.find(".feed-sidebar-content-create-form-type_e");a.find(".feed-sidebar-content-create-form-doc-label");a.find(".feed-sidebar-content-create-form-group-doc-create");ka=a.find(".feed-sidebar-content-create-form-file");la=a.find(".feed-sidebar-content-create-form-group-doc-delete");K=a.find(".feed-sidebar-content-create-form-x");U=a.find(".feed-sidebar-content-create-form-y");
aa=a.find(".is_selected");ba=a.find(".feed-sidebar-content-help-email");ma=a.find(".list-refresh");na=a.find(".list-download");ca=a.find(".report-send");J=a.find(".report-modify");oa=a.find(".report-cancel");pa=a.find(".report-create");da=a.find(".feed-sidebar-modal-img-title");ea=a.find(".feed-sidebar-modal-img-body-img");fa=a.find(".feed-sidebar-modal-message");qa=a.find(".feed-sidebar-modal-message-header");a.find(".feed-sidebar-modal-message-title");ra=a.find(".feed-sidebar-modal-message-body-p")};
L=function(a,b){var c="bg-"+b.type;c!=m&&(qa.toggleClass(m+" "+c),m=c);ra.html(feed.util_b.encodeHtml(b.text));fa.modal("show");setTimeout(function(){fa.modal("hide")},3500)};M=function(){w.html(" - ");y.val("").attr("placeholder","Ex: AL 123");t.val("");n.val("");u.val("");A.val("").attr("placeholder","Ex: piste, citerne, PBI, route, b\u00e2timent, barri\u00e8re...");E.html(" - ");z.html(" - ");H.html("");v.val("").attr("placeholder","Longitude");e.val("").attr("placeholder","Latitude");c.hide();
P.val("").attr("placeholder","No file");aa.show();b=null;V();da.val("");ea.attr("src","");N()};V=function(){S.val("").attr("placeholder","Ex: AL 123");Y.val("");T.val("");Z.val("").attr("placeholder","Ex: piste, citerne, PBI, route, b\u00e2timent, barri\u00e8re...");K.val("").attr("placeholder","Longitude");U.val("").attr("placeholder","Latitude");ka.val("").attr("placeholder","No file")};ta=function(){k.html("No report to display")};N=function(){h.get(0).reset();R.get(0).reset()};W=function(a){Q.hide();
ja.fileupload({dataType:"json",add:La,progress:function(a,b){var c=parseInt(b.loaded/b.total*100,10);X.css("width",c+"%")},done:Ma})};ha=function(b){var c=!0,e;e=$(b.currentTarget);b=l;if(!e.hasClass("tab"))return!1;e=e[0].id.split("t_")[1];"opened"===d&&e===b&&(c=!1);a.set_sidebar_anchor({sidebar:c?"opened":"closed",tab:e});return!1};ua=function(c){a.people_model.get_user().get_is_anon()?(L(null,{text:"Veuillez vous logger !",type:"warning"}),M(),ta()):x.children(".has-error").length?(L(null,{text:"Veuillez compl\u00e9ter le formulaire !",
type:"warning"}),c.preventDefault()):v.val()&&y.val()&&(b?(c=feed.util_b.coordL93ToWgs84(v.val(),e.val()),a.reports_model.update_({_id:b,locate_map:{x:c.x.toFixed(0),y:c.y.toFixed(0)},id_equi:y.val(),textarea:t.val(),statu:n.val(),type_r:u.val(),type_e:A.val(),action:B.val(),cible:C.val()})):(L(null,{text:"Veuillez s\u00e9lectionner un rapport dans la liste !",type:"warning"}),c.preventDefault()))};La=function(c,e){e.formData={report_id:b};console.dir(e);a.reports_model.upload_(e)};Ma=function(c,
b){console.dir(b);Q.hide();b.context=Q.text("").replaceAll("#result");X.css("width","0%");a.sidebar_model.update_list([b._response.result])};xa=function(a){a=$(a.target);if(!a.hasClass("g-popup"))return!1;a=a.attr("gly-id");$.gevent.publish("feed-displayinfo",a)};wa=function(b){b=$(b.target);if(!b.hasClass("g-remove"))return!1;b=b.attr("gly-id");if(!b)return!1;a.sidebar_model.set_report(b);confirm("Voulez-vous supprimer ce rapport ?")&&a.reports_model.delete_(b)};va=function(c){c=$(c.target);if(!c.hasClass("g-edit"))return!1;
c=c.attr("gly-id");if(!c)return!1;c!==b&&(N(),a.sidebar_model.set_report(c));a.set_sidebar_anchor({sidebar:"opened",tab:"report"});return!1};ya=function(c){b&&(N(),a.reports_model.cancel_(b))};za=function(c){K.val()&&S.val()&&(c=feed.util_b.coordL93ToWgs84(K.val(),U.val()),a.reports_model.create_({locate_map:{x:c.x.toFixed(0),y:c.y.toFixed(0)},id_equi:S.val(),textarea:Y.val(),type_r:T.val(),type_e:Z.val()}),a.set_sidebar_anchor({sidebar:"opened",tab:"home"}))};Aa=function(c){confirm("Voulez-vous supprimer ce document ?")&&
(a.reports_model.delete_doc_(b),O.html(""),I.hide(),D.show(),console.log("############################### onTapDeleteDoc "+b),W(b))};Ca=function(a){$.gevent.publish("feed-selectstatu",$(a).val())};Ba=function(c){c=$(c.elem_target.parentNode);if(!c.hasClass("feed-sidebar-content-list-name"))return!1;c=c.attr("tr-id");if(!c||c===b)return!1;a.sidebar_model.set_report(c);return!1};ia=function(c,b){var e;da.html(b);(e=a.reports_model.get_by_cid(b))&&/\.(gif|jpg|jpeg|tiff|png)$/i.test(e.doc)&&ea.attr("src",
e.doc);return!1};Da=function(c){a.sidebar_model.get_list()};Pa=function(c){c=ga();var b=$("#tableReports").DataTable().rows().ids().length;b&&(b===c.length&&(c=[]),a.sidebar_model.down_list(c))};Ea=function(f,g){var h,d=g.new_report,l=a.people_model.get_user().rules_map.update_;if(d.get_is_empty())return M(),!1;k.find(".feed-sidebar-content-list-name").removeClass("feed-x-select").end().find("[tr-id="+d.id+"]").addClass("feed-x-select");N();aa.hide();b=d.id;w.html(d.id);y.val(d.id_equi);console.log("new_report.id_equi: "+
d.id_equi);t.val(d.textarea);n.val(d.statu);u.val(d.type_r);A.val(d.type_e);B.val(d.action);C.val(d.cible);E.html(d.created);z.html(d.modified);H.html(d.owner);d.history_status&&0<d.history_status.length?(r.DataTable({data:d.history_status,paging:!1,ordering:!1,searching:!1,info:!1,destroy:!0,createdRow:function(a,c,b){switch(c[0]){case "REJETE":$("td:eq(0)",a).html(feed.util_b.toLiterary("REJETE"));break;case "COURS":$("td:eq(0)",a).html(feed.util_b.toLiterary("COURS"));break;case "TRAITE":$("td:eq(0)",
a).html(feed.util_b.toLiterary("TRAITE"));break;default:$("td:eq(0)",a).html(feed.util_b.toLiterary("ATTENTE"))}},language:{emptyTable:"Aucun \u00e9l\u00e9ment \u00e0 afficher"}}),c.show()):c.hide();h=feed.util_b.coordWgs84ToL93(d.locate_map.x,d.locate_map.y);v.val(h.x.toFixed(0));e.val(h.y.toFixed(0));console.log("user_up: "+l+" / jqueryMap.$report_statu.val(): "+n.val());l||"ATTENTE"==n.val()?(J.prop("disabled",!1),J.attr("title","Envoyer la modification")):(J.prop("disabled",!0),J.attr("title",
"Seul l'administrateur a les droits de modification"));d.doc?(O.html('<a href="/media/'+d.doc+'" target="_blank">'+d.doc+"</a>"),D.hide(),(l||"ATTENTE"==n.val())&&I.show(),console.log("############################### 1 "+d.id),W(null)):(O.html(""),I.hide(),console.log("############################### 2 "+d.id),W(d.id),(l||"ATTENTE"==n.val())&&D.show());ca.attr("href","mailto:?subject=Remont\u00e9e d'informations - Rapport "+d.id+" \u00e0 votre attention&body=Bonjour,%0D%0ALe rapport "+d.id+" r\u00e9dig\u00e9 dans l'application G\u00e9o DFCI (http://www.sig-dfci.org) vous est destin\u00e9.%0D%0AMerci de prendre en compte cette information et de me faire part, par retour de mail, de l'\u00e9tat d'avancement de ce dossier.%0D%0A%0D%0AVous en remerciant par avance et restant \u00e0 votre disposition.%0D%0ACordialement,");
V();ia(null,d.id);return!0};Fa=function(c){var e,d;c=a.people_model.get_user();var r=!1;d=a.reports_model.get_db();var g=String();e=c.rules_map.update_;g+='<div class="table-responsive"><table id="tableReports" class="table table-striped table-hover" cellspacing="0" width="100%" role="grid" style="width: 100%;"><thead><tr><th></th><th>Cr&eacute;ation</th><th>Statut</th><th>Type</th><th>&Eacute;quip.</th><th></th>';e&&(g+="<th></th><th></th><th></th>");g+="</tr></thead><tbody>";d().each(function(a,
c){var d="",f="",k="";a.statu&&(f=feed.util_b.encodeHtml(n.find("option[value="+a.statu+"]").val()));a.type_r&&(k=feed.util_b.encodeHtml(T.find("option[value="+a.type_r+"]").val()));if(a.get_is_empty())return!0;b&&b===a.id&&(d=" feed-x-select");g+='<tr class="feed-sidebar-content-list-name'+d+'" tr-id="'+a.id+'"><td data-id="'+a.id+'">'+a.id+'</td><td scope="row">'+feed.util_b.encodeHtml(a.created)+'</td><td class="feed-sidebar-content-list-td-statu-'+a.statu.toLowerCase()+'"><strong>'+f+"</strong></td><td>"+
k+"</td><td>"+feed.util_b.encodeHtml(a.type_e)+'</td><td><span class="glyphicon glyphicon-list g-popup" gly-id="'+a.id+'" aria-hidden="true" title="afficher"></span></td>';e&&(g+='<td><span class="glyphicon glyphicon-cog g-edit" gly-id="'+a.id+'" aria-hidden="true" title="modifier"></span></td><td><span class="glyphicon glyphicon-remove g-remove" gly-id="'+a.id+'" aria-hidden="true" title="supprimer"></span></td></td><td class="text-center feed-sidebar-content-list-td-mailto"><a href="mailto:'+a.owner+
"&subject=Remont\u00e9e d'informations - Rapport "+a.id+'&body=Message de l\'administrateur" title="'+a.owner+'" class="fa fa-envelope tltip" data-toggle="tooltip" data-placement="left"></a></td>');g+="</tr>";r=!0});g+="</tbody></table></div>";r||(g=String()+'<div class="spa-chat-list-note text-right"><h5>Aucun rapport &agrave; afficher !</h5></div>',M());k.html(g);f.find(".g-popup").bind("click",xa);f.find(".g-remove").bind("click",wa);f.find(".g-edit").bind("click",va);k.find("tr").bind("mouseover",
Ga);k.find("tr").bind("mouseout",Ha);d=e?[{visible:!1},null,null,null,null,{orderable:!1},{orderable:!1},{orderable:!1},{orderable:!1}]:[{visible:!1},null,null,null,null,{orderable:!1}];$("#tableReports").DataTable({dom:'<"top"f>rt<"bottom"ip><"clear">',autoWidth:!0,pageLength:15,language:{url:"//cdn.datatables.net/plug-ins/1.10.11/i18n/French.json"},order:[[0,"desc"]],columns:d}).on("search.dt",function(a,c){setTimeout(function(){var a=ga(),c=$("#tableReports").DataTable().rows().ids().length;c===
a.length&&(a=[]);console.log("dt_length: "+c+" / tab.length: "+a.length);$.gevent.publish("feed-search",[a])},1E3)});ba.html(c.admins);ba.attr("href","mailto:"+c.admins);V();return!1};Ga=function(a){a=$(a.currentTarget);if(!a.hasClass("feed-sidebar-content-list-name"))return!1;a=a.attr("tr-id");if(!a)return!1;$.gevent.publish("feed-listhover",a)};Ha=function(a){$.gevent.publish("feed-listhover","")};Ia=function(a,c){c?k.find("[tr-id="+c+"]").addClass("tr-selected"):k.find("tr").removeClass("tr-selected")};
Ja=function(a,c){var b=feed.util_b.coordWgs84ToL93(c.x,c.y);K.val(b.x.toFixed(0));U.val(b.y.toFixed(0))};Ka=function(a,c){var b=feed.util_b.coordWgs84ToL93(c.x,c.y);v.val(b.x.toFixed(0));e.val(b.y.toFixed(0))};Na=function(c,b){a.people_model.get_user().rules_map.update_||(n.prop("disabled",!0),G.hide(),F.hide(),ca.hide())};Oa=function(c,b){a.set_sidebar_anchor({sidebar:"closed"});M()};return{setSliderPosition:function(a,c,b){switch(a){case "opened":f.trigger("opening");f.removeClass("collapsed");
p.removeClass("active").filter("#t_"+c).addClass("active");q.find(".sidebar-pane").removeClass("active").end().find("#"+c).addClass("active");$("#tableReports").DataTable().draw();break;case "hidden":break;case "closed":f.trigger("closing").addClass("collapsed");p.removeClass("active");break;default:return!1}d=a;l=c;b&&b(f);return!0},removeSlider:function(a){f&&(a?(f.hide(),$.gevent.publish("feed-removeslider",!0)):(f.show(),$.gevent.publish("feed-removeslider",!1)));return!0},handleResize:void 0,
configModule:function(c){feed.util.setConfigMap({input_map:c,settable_map:a.settable_map,config_map:a});return!0},initModule:function(b){g=b;b.append(a.main_html);sa();p.click(ha);d="closed";b=k;$.gevent.subscribe(b,"feed-listchange",Fa);$.gevent.subscribe(b,"feed-setreport",Ea);$.gevent.subscribe(b,"feed-login",Na);$.gevent.subscribe(b,"feed-logout",Oa);$.gevent.subscribe(b,"feed-hover",Ia);$.gevent.subscribe(b,"feed-clickmarker",ia);$.gevent.subscribe(b,"feed-alert",L);$.gevent.subscribe(R,"feed-coord",
Ja);$.gevent.subscribe(R,"feed-setcoord",Ka);p.bind("utap",ha);b.bind("utap",Ba);ma.bind("click",Da);na.bind("click",Pa);J.bind("click",ua);oa.bind("click",ya);pa.bind("click",za);I.bind("click",Aa);n.selected(function(a){Ca(a)});I.hide();la.hide();D.hide();c.hide()}}}();feed.map=function(){var a={settable_map:{map_model:!0,people_model:!0,reports_model:!0,set_map_anchor:!0,doc_path:!0},map_model:null,people_model:null,reports_model:null,set_content_anchor:null},g=null,d=null,l=null,b=null,m=null,f=null,p=null,q=!1,k={},h,x,w,y,t,n,u,A,B,F,G,C,E,z,H;h=function(){var c,r,h,e,m,D,P=d;c=new OpenLayers.Size(21,25);new OpenLayers.Pixel(-(c.w/2),-c.h);m=(m=OpenLayers.Util.getParameters(window.location.href).renderer)?[m]:OpenLayers.Layer.Vector.prototype.renderers;c=new OpenLayers.Style({graphicWidth:24,
graphicHeight:24,pointRadius:10,graphicZIndex:100,title:"${tooltip}"});h=new OpenLayers.Style(OpenLayers.Util.applyDefaults({pointRadius:5,graphicZIndex:50},OpenLayers.Feature.Vector.style["default"]));c=new OpenLayers.StyleMap({"default":{backgroundGraphic:"/static/libs/feedback/src/img/marker_shadow.png",backgroundXOffset:0,backgroundYOffset:-7,backgroundGraphicZIndex:10,graphicZIndex:11,pointRadius:10,cursor:"pointer",title:"${tooltip}"},over:c,selected:h});r=new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults({fillColor:"#ff0000",
fillOpacity:1,graphicZIndex:2E3},OpenLayers.Feature.Vector.style["default"])});e=new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults({fillColor:"#ff0000",fillOpacity:1,pointRadius:8,graphicZIndex:2E3},OpenLayers.Feature.Vector.style.select)});h=new OpenLayers.Layer.Vector("layer_markers",{renderers:m,eventListeners:{featureclick:function(a){console.log("featureclick e.feature.popup.id: "+a.feature.popup.id);b&&(console.log("featureclick stateMap.current_popup.id: "+b.id),b.id!==a.feature.popup.id?
n():(k.$click_feature.unselectAll(),f=null));a.feature.popup.toggle();a.feature.popup.visible()&&(b=a.feature.popup);return!1},nofeatureclick:function(a){n()},featureover:function(a){var c=a.feature,b=c.attributes.id;"default"==c.renderIntent&&(a.feature.renderIntent="over",a.feature.layer.drawFeature(a.feature));q&&l&&l.attributes.id===b?(console.log("feed.map_ol2 featureover dragMarkers.activate()"),D.activate()):(console.log("feed.map_ol2 featureover dragMarkers.deactivate()"),D.deactivate());
$.gevent.publish("feed-hover",b)},featureout:function(a){"over"==a.feature.renderIntent&&(f?a.feature.id!==f.id&&(a.feature.renderIntent="default",a.feature.layer.drawFeature(a.feature)):(a.feature.renderIntent="default",a.feature.layer.drawFeature(a.feature)));$.gevent.publish("feed-hover","")}}});r=new OpenLayers.Layer.Vector("layer_new",{renderers:m,styleMap:r});m=new OpenLayers.Layer.Vector("layer_select",{renderers:m,styleMap:e});D=new OpenLayers.Control.DragFeature(h,{id:"dragmarkers",onStart:function(a,
c){q&&n()},onDrag:function(a,c){$.gevent.publish("feed-setcoord",{x:a.geometry.x.toFixed(0),y:a.geometry.y.toFixed(0)})},onComplete:function(c,b){var e,d={locate_map:{}};e=a.reports_model.get_by_cid(c.data.id);var f=feed.util_b.coordWgs84ToL93(c.geometry.x,c.geometry.y);k.$layer_select.destroyFeatures();d.id=c.data.id;d.locate_map.x=c.geometry.x.toFixed(0);d.locate_map.y=c.geometry.y.toFixed(0);e&&(d.id_equi=e.title,d.textarea=e.textarea,d.statu=e.statu,d.type_r=e.type_r,d.type_e=e.type_e,d.created=
e.datecreate,d.modified=e.modified,d.owner=e.owner,d.img=e.img,d.doc=e.doc);e=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(d.locate_map.x,d.locate_map.y));k.$layer_select.addFeatures([e]);c.popup.setContentHTML(t(d));c.popup.lonlat.lon=f.x.toFixed(0);c.popup.lonlat.lat=f.y.toFixed(0);this.deactivate()}});g.addControl(D);g.events.register("moveend",g,function(a){p&&(p.move(this.getCenter()),$.gevent.publish("feed-coord",{x:p.geometry.x.toFixed(0),y:p.geometry.y.toFixed(0)}))});e=new OpenLayers.Control.SelectFeature(h,
{renderIntent:"over",clickout:!0,toggle:!0,multiple:!1});g.addControl(e);e.activate();g.addLayer(m);g.addLayer(r);g.addLayer(h);c.addUniqueValueRules("default","statu",{TRAITE:{externalGraphic:"/static/libs/feedback/src/img/marker-green.png"},COURS:{externalGraphic:"/static/libs/feedback/src/img/marker-gold.png"},REJETE:{externalGraphic:"/static/libs/feedback/src/img/marker-gray.png"},ATTENTE:{externalGraphic:"/static/libs/feedback/src/img/marker.png"}});h.styleMap=c;k={$layer_markers:h,$layer_new:r,
$layer_select:m,$map_div:P,$marker_list:[],$click_feature:e,$styleMarker:void 0}};x=function(a){var c=null;a&&(c=k.$marker_list[a]);return c};w=function(c){var d,f,e;c&&(d=x(c))&&(l=d,f=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(d.geometry.x,d.geometry.y)),k.$layer_select.addFeatures([f]),l.renderIntent="selected",k.$layer_markers.drawFeature(l),b=e=k.$marker_list[d.data.id].popup,(c=a.reports_model.get_by_cid(c))?(e=new OpenLayers.LonLat(c.locate_map.x,c.locate_map.y),d.move(e),
f.move(e),g.panTo([c.locate_map.x,c.locate_map.y])):g.panTo([d.geometry.x,d.geometry.y]))};y=function(){k.$layer_select.destroyFeatures();l&&(l.renderIntent="default",k.$layer_markers.drawFeature(l),l=null);n()};t=function(c){var b;b=a.people_model.get_user();var d=String();b=b.rules_map.update_;d+="<label>Rapport "+c.id+'</label><table class="table table-condensed feed-popup-content-head"><tbody><tr><td><label>Cr\u00e9ation</label></td><td>'+c.created+"</td></tr><tr><td><label>Modification</label></td><td>"+
c.modified+"</td></tr><tr><td><label>Auteur</label></td><td>"+c.owner+'</td></tr><tr><td><label>Statut</label></td><td class="feed-popup-content-statu-'+c.statu.toLowerCase()+'"><b>'+feed.util_b.toLiterary(c.statu)+'</b></td></tr></tbody></table><table class="table table-condensed feed-popup-content-body"><tbody><tr><td><label>Type de rapport:</label></td></tr><tr><td class="feed-popup-content-body-td-text">'+feed.util_b.toLiterary(c.type_r)+'</td></tr><tr><td><label>Type d\'\u00e9quipement:</label></td></tr><tr><td class="feed-popup-content-body-td-text">'+
c.type_e+'</td></tr><tr><td><label>Identifiant de l\'\u00e9quipement:</label></td></tr><tr><td class="feed-popup-content-body-td-text">'+c.id_equi+'</td></tr><tr><td class="feed-popup-content-body-td-label"><label>Description:</label></td></tr></tbody></table><p class="feed-popup-content-desc">'+c.textarea+"</p>";c.doc&&(d=/\.(gif|jpg|jpeg|tiff|png)$/i.test(c.doc)?d+('<a target="_blank" href="/media/'+c.doc+'"><img class="feed-map-popup-img img-responsive img-thumbnail center-block" alt="No image" src="/media/'+
c.doc+'"></a>'):d+('<div><a href="/media/'+c.doc+'" target="_blank">'+c.doc+"</a></div>"));b&&(d+='<table class="table table-condensed feed-popup-content-coord"><tbody><tr colspan="2"><td class="feed-popup-content-body-td-label"><label>Coordonn\u00e9es en Lambert 93</label></td></tr><tr><td>Lattitude</td><td>'+c.locate_map.y+"</td></tr><tr><td>Longitude</td><td>"+c.locate_map.x+"</td></tr></tbody></table>",d+='<table class="table table-condensed feed-popup-content-footer"><tbody><tr><td><label>Action</label></td><td>'+
feed.util_b.toLiterary(c.action)+"</td></tr><tr><td><label>Cible</label></td><td>"+feed.util_b.toLiterary(c.cible)+"</td></tr></tbody></table>");return d};n=function(){b&&(b.hide(),b=null)};u=function(a){var c=k.$layer_markers.features;console.dir(c);for(var b=0;b<c.length;b++){var e=c[b];-1===a.indexOf(e.attributes.id)&&(e.style={visibility:"hidden"})}k.$layer_markers.redraw()};A=function(){for(var a=k.$layer_markers.features,b=0;b<a.length;b++){var d=a[b];d.style&&(d.style=null)}k.$layer_markers.redraw()};
B=function(a,d){var c;y();console.log("feed.map_ol2 onSetReport dragMarkers.deactivate()");g.getControl("dragmarkers").deactivate();d.new_report&&((c=x(d.new_report.id))&&w(c.attributes.id),d.new_report==d.old_report&&b&&(b.setContentHTML(t(d.new_report)),b.lonlat.lon=d.new_report.locate_map.x,b.lonlat.lat=d.new_report.locate_map.y));return!1};F=function(c){c=a.reports_model.get_db();var b=a.reports_model.get_current(),d=[];k.$layer_markers.removeAllFeatures();console.log("feed.map_ol2 onListchange dragMarkers.deactivate()");
g.getControl("dragmarkers").deactivate();c().each(function(a,c){var b,e;e={locate_map:{}};e.id=a.id;e.locate_map.x=a.locate_map.x;e.locate_map.y=a.locate_map.y;e.id_equi=a.id_equi;e.textarea=a.textarea;e.type_r=a.type_r;e.type_e=a.type_e;e.action=a.action;e.cible=a.cible;e.created=a.created;e.modified=a.modified;e.owner=a.owner;e.img=a.img;e.doc=a.doc;e.statu=a.statu;b=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a.locate_map.x,a.locate_map.y),{id:a.id,tooltip:a.id,statu:a.statu});
e=new OpenLayers.Popup.FramedCloud(a.id,OpenLayers.LonLat.fromString(b.geometry.toShortString()),null,t(e),null,!0,function(a){n()});e.panMapIfOutOfView=!1;e.maxSize=new OpenLayers.Size(450,600);e.keepInMap=!0;e.disableFirefoxOverflowHack=!0;b.popup=e;g.addPopup(b.popup);b.popup.hide();d.push(b);k.$marker_list[a.id]=b});k.$layer_markers.addFeatures(d);k.$layer_markers.redraw();b&&w(b.id);return!1};G=function(a,b){var c,d=!1;b?(c=x(b),l?c&&c.id!==l.id?d=!0:m=c:d=!0):m&&(l?m.id!==l.id&&(m.renderIntent=
"default",k.$layer_markers.drawFeature(m),k.$click_feature.unselectAll()):(m.renderIntent="default",k.$layer_markers.drawFeature(m),k.$click_feature.unselectAll()),m=null);d&&(c.renderIntent="over",k.$layer_markers.drawFeature(c),m=c)};C=function(a,b){k.$layer_markers.clearLayers()};E=function(a,b){b?(g.removeLayer(k.$layer_markers),g.removeLayer(k.$layer_new),g.removeLayer(k.$layer_select),n()):(g.addLayer(k.$layer_markers),g.addLayer(k.$layer_new),g.addLayer(k.$layer_select));return!0};z=function(a,
b){b.length?u(b):A()};H=function(a,d){var c=k.$marker_list[d].popup;n();c&&(c.toggle(),c.panIntoView(),b=c)};return{setMarkerPosition:function(a,b,d){switch(a){case "opened":"create"===b?(a=g.getCenter(),p=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a.lon,a.lat)),k.$layer_new.addFeatures([p]),$.gevent.publish("feed-coord",{x:p.geometry.x.toFixed(0),y:p.geometry.y.toFixed(0)})):(k.$layer_new.removeAllFeatures(),p=null);q="report"===b?!0:!1;break;default:return!1}},configModule:function(c){feed.util.setConfigMap({input_map:c,
settable_map:a.settable_map,config_map:a});return!0},initModule:function(a){var b=$("#mappanel");g=a;d=b;h();$.gevent.subscribe(b,"feed-listchange",F);$.gevent.subscribe(b,"feed-setreport",B);$.gevent.subscribe(b,"feed-logout",C);$.gevent.subscribe(b,"feed-listhover",G);$.gevent.subscribe(b,"feed-removeslider",E);$.gevent.subscribe(b,"feed-search",z);$.gevent.subscribe(b,"feed-displayinfo",H)}}}();
