var $jscomp={scope:{},findInternal:function(a,k,e){a instanceof String&&(a=String(a));for(var l=a.length,h=0;h<l;h++){var c=a[h];if(k.call(e,c,h,a))return{i:h,v:c}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,k,e){if(e.get||e.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[k]=e.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,k,e,l){if(k){e=$jscomp.global;a=a.split(".");for(l=0;l<a.length-1;l++){var h=a[l];h in e||(e[h]={});e=e[h]}a=a[a.length-1];l=e[a];k=k(l);k!=l&&null!=k&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:k})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,e){return $jscomp.findInternal(this,a,e).v}},"es6-impl","es3");var feed=function(){return{initModule:function(a,k,e){a=$("#"+a);e=e?e:null;feed.model.initModule();feed.shell.initModule(a,k,e)}}}();feed.util=function(){var a;a=function(a,e,l){var h=Error();h.name=a;h.message=e;l&&(h.data=l);return h};return{makeError:a,setConfigMap:function(k){var e=k.input_map,l=k.settable_map;k=k.config_map;for(var h in e)if(e.hasOwnProperty(h))if(l.hasOwnProperty(h))k[h]=e[h];else throw e=a("Bad Input","Setting config key |"+h+"| is not supported"),e;}}}();feed.data=function(){return{}}();feed.fake=function(){var a,k,e,l;a=[];k={admin:{list_:!0,create_:!0,read_:!0,update_:!0,delete_:!0},view:{list_:!0,create_:!1,read_:!1,update_:!1,delete_:!1}};e=function(){var h={};return{emit:function(c,f){var e;"adduser"===c&&h.userupdate&&setTimeout(function(){e={_id:f.cid,rule:f.rule,rules_map:k[f.rule]};a.push(e);h.userupdate([e])},10)},on:function(a,f){h[a]=f}}}();l=function(){var a={};return{emit:function(c,f){"createreport"===c&&a.listchange?f.cid?$.post("../feed/",f,function(c){a.listchange([c,
f])},"json"):f.submit():"updatereport"===c&&a.listchange?$.post("../feed/",f).done(function(c){a.listchange([c])},"json"):"uploadreport"===c&&a.listchange?f.submit():"deletedoc"===c&&a.listchange?$.get("../feed/",{id:f,doc:!0}).done(function(c){a.listchange([c])},"json"):"deletereport"===c&&a.listchange?$.get("../feed/",{id:f}).done(function(c){a.listchange([c])},"json"):"getreports"===c&&a.listchange?$.get("../feed/",function(c){a.listchange([c])},"json"):"downloadreports"===c&&(window.location.href=
"../feed/csv/?ids="+f.list.toString())},on:function(c,f){a[c]=f}}}();return{mockSio:e,mockSioReport:l}}();feed.model=function(){var a={anon_id:"a0",anon_rules_map:{list_:!0,read_:!1,create_:!1,update_:!1,upload:!1,delete_doc_:!1,delete_:!1},anon_rule:"anonymous",empty_id:"e0",empty_title:"",empty_textarea:"",empty_statu:"",empty_type_r:"",empty_type_e:"",empty_created:"",empty_modified:"",empty_owner:"",empty_history:"",empty_locate_map:{x:0,y:0}},k=null,e=0,l=0,h={},c=TAFFY(),f=null,n=null,q={},m=TAFFY(),g=null,v,w,y,t,r,p,C,x,E,H,F,G,z;v={get_is_user:function(){return this.cid===f.cid},get_is_anon:function(){return this.cid===
k.cid}};w=function(){return"c"+String(e++)};y=function(){var a=f;c=TAFFY();h={};a&&(c.insert(a),h[a.cid]=a)};t=function(a){a=a[0];delete h[a.cid];f.cid=a._id;f.id=a._id;f.rule=a.rule;f.rules_map=a.rules_map;h[a._id]=f;z.get_list();$.gevent.publish("feed-login",[f])};r=function(a){var d=a.cid,A=a.id,B=a.rules_map,b=a.rule;if(void 0===d||!b)throw"makePerson exception : client id required";a=Object.create(v);a.cid=d;a.rule=b;a.rules_map=B;A&&(a.id=A);h[d]=a;c.insert(a);return a};p=function(){return{get_by_cid:function(a){return h[a]},
get_db:function(){return c},get_user:function(){return f},login:function(a){var d=feed.fake.mockSio;f=r({cid:w(),rule:a});d.on("userupdate",t);d.emit("adduser",{cid:f.cid,rule:f.rule})},logout:function(){var a=f;z._leave();f=k;y();$.gevent.publish("feed-logout",[a])}}}();C={get_is_report:function(){return this.cid===g.cid},get_is_empty:function(){return this.cid===a.empty_id}};x=function(){return"c"+String(l++)};E=function(){m=TAFFY();q={}};H=function(a){};F=function(a){var d=a.cid,u=a.id,B=a.id_equi,
b=a.textarea,c=a.statu,g=a.type_r,f=a.type_e,k=a.action,h=a.cible,e=a.history_status,A=a.created,l=a.modified,y=a.owner,t=a.locate_map,n=a.doc;if(void 0===d)throw"report id required";a=Object.create(C);a.cid=d;a.id_equi=B;a.textarea=b;a.statu=c;a.type_r=g;a.type_e=f;a.action=k;a.cible=h;a.history_status=e;a.locate_map=t;a.created=A;a.modified=l;a.owner=y;a.doc=n;u&&(a.id=u);q[d]=a;m.insert(a);return a};G=function(){return{get_by_cid:function(a){return q[a]},get_db:function(){return m},get_current:function(){return g},
create_:function(a){var d;if(f.get_is_anon())return console.warn("D\u00e9sol\u00e9, vous devez vous connecter !"),!1;d=feed.fake.mockSioReport;d.on("addreport",H);if(a.doc){var u=[{name:"cid",value:x()},{name:"y",value:a.locate_map.y},{name:"x",value:a.locate_map.x},{name:"id_equi",value:a.id_equi},{name:"textarea",value:a.textarea},{name:"statu",value:a.statu},{name:"type_r",value:a.type_r},{name:"type_e",value:a.type_e}];a.doc.formData=u;a=a.doc}else a={cid:x(),locate_map:a.locate_map,id_equi:a.id_equi,
textarea:a.textarea,statu:a.statu,type_r:a.type_r,type_e:a.type_e,doc:a.doc};d.emit("createreport",a)},delete_:function(a){var d=feed.fake.mockSioReport;d&&d.emit("deletereport",a)},update_:function(a){var d=feed.fake.mockSioReport;d&&d.emit("updatereport",a)},upload_:function(a){var d=feed.fake.mockSioReport;d&&d.emit("uploadreport",a)},delete_doc_:function(a){var d=feed.fake.mockSioReport;d&&d.emit("deletedoc",a)},cancel_:function(a){g.id===a&&$.gevent.publish("feed-setreport",{old_report:g,new_report:g})}}}();
z=function(){var a,d,u;d=function(a){var b,d=a[0].data?a[0].data:[];b=a[0].user;var B=a[0].message?a[0].message:null,c=!1,k=!1;b&&(f.email=b.email,f.admins=b.admins);E();1<a.length&&(B?$.gevent.publish("feed-alert",{text:B,type:"danger"}):(b=a[1],delete q[b.cid],g.cid=b._id,g.id=b._id,g.id_equi=b.id_equi,g.textarea=b.textarea,g.statu=b.statu,g.type_r=b.type_r,g.type_e=b.type_e,g.action=b.action,g.cible=b.cible,g.created=b.created,g.modified=b.modified,g.owner=b.owner,g.history_status=b.history_status,
g.locate_map=b.locate_map,g.doc=b.doc,c=k=!0,$.gevent.publish("feed-alert",{text:"Le rapport a \u00e9t\u00e9 cr\u00e9\u00e9 avec succ\u00e8s !",type:"primary"})));a=0;a:for(;a<d.length;a++){b=d[a];g.get_is_empty()||g.id!==b._id||(k||B?$.gevent.publish("feed-alert",{text:B,type:"danger"}):($.gevent.publish("feed-alert",{text:"La mise \u00e0 jour a \u00e9t\u00e9 r\u00e9alis\u00e9e avec succ\u00e8s !",type:"primary"}),g.id_equi=b.id_equi,g.textarea=b.textarea,g.statu=b.statu,g.type_r=b.type_r,g.type_e=
b.type_e,g.action=b.action,g.cible=b.cible,g.created=b.created,g.modified=b.modified,g.owner=b.owner,g.history_status=b.history_status,g.locate_map=b.locate_map,g.doc=b.doc),$.gevent.publish("feed-setreport",{old_report:g,new_report:g}),c=!0);if(b&&!b._id)continue a;b={cid:b._id,locate_map:b.locate_map,id:b._id,id_equi:b.id_equi,textarea:b.textarea,statu:b.statu,type_r:b.type_r,type_e:b.type_e,action:b.action,cible:b.cible,created:b.created,modified:b.modified,owner:b.owner,history_status:b.history_status,
doc:b.doc};F(b)}m.sort("id");c||(g.get_is_empty()?$.gevent.publish("feed-alert",{text:"La mise \u00e0 jour a \u00e9t\u00e9 r\u00e9alis\u00e9e avec succ\u00e8s !",type:"primary"}):($.gevent.publish("feed-alert",{text:"Le rapport a \u00e9t\u00e9 supprim\u00e9 avec succ\u00e8s !",type:"primary"}),u("")))};a=function(a){d(a);$.gevent.publish("feed-listchange",[a[0].data])};u=function(a){if(a=q[a]){if(g&&g.id===a.id)return!1}else a=n;$.gevent.publish("feed-setreport",{old_report:g,new_report:a});g=a;return!0};
return{_leave:function(){var a=feed.fake.mockSioReport;a&&a.emit("leavelist")},get_report:function(){return g},get_list:function(){var d;if(f.get_is_anon())return $.gevent.publish("feed-alert",{text:"D\u00e9sol\u00e9, vous devez vous connecter avant !",type:"warning"}),!1;d=feed.fake.mockSioReport;d.on("listchange",a);d.emit("getreports",{user:f});return!0},update_list:function(d){a(d)},down_list:function(a){if(f.get_is_anon())return $.gevent.publish("feed-alert",{text:"D\u00e9sol\u00e9, vous devez vous connecter avant !",
type:"warning"}),!1;feed.fake.mockSioReport.emit("downloadreports",{list:a});return!0},set_report:u}}();return{initModule:function(){f=k=r({cid:a.anon_id,id:a.anon_id,rules_map:a.anon_rules_map,rule:a.anon_rule});g=n=F({cid:a.empty_id,id:a.empty_id,id_equi:a.empty_title,textarea:a.empty_textarea,statu:a.empty_statu,type_r:a.empty_type_r,type_e:a.empty_type_e,action:a.empty_action,cible:a.empty_cible,created:a.empty_created,modified:a.empty_modified,owner:a.empty_owner,locate_map:a.empty_locate,history_status:a.empty_history})},
people:p,reports:G,sidebar:z,map:{}}}();feed.util_b=function(){var a=/[&"'><]/g,k=/["'><]/g,e={"&":"&#38;",'"':"&#34;","'":"&#39;",">":"&#62;","<":"&#60;"},l={ATTENTE:"En attente",COURS:"En cours",TRAITE:"Trait&eacute;",REJETE:"Rejet&eacute;",PROBLEME:"Un dysfonctionnement concernant un &eacute;quipement",ERREUR:"Une erreur sur la cartographie",INFO:"Information",CREATION:"Cr&eacute;ation",MODIF:"Modification",DEPLACE:"D&eacute;placement",SUPRIME:"Suppression",SDIS:"SDIS",BMPM:"BMPM",ONF:"ONF",DDTM:"DDTM",DFCI:"Commission DFCI",CD:"CD",
AUTRE:"Autre..."},h;h=$.extend({},e);delete h["&"];return{decodeHtml:function(a){return $("<div/>").html(a||"").text()},encodeHtml:function(c,f){var l=String(c),q,m;f?(m=h,q=k):(m=e,q=a);return l.replace(q,function(a,c){return m[a]||""})},coordWgs84ToL93:function(a,k){var c=new OpenLayers.Projection("EPSG:900913"),f=new OpenLayers.Projection("EPSG:2154"),h=new OpenLayers.Geometry.Point(a,k);h.transform(c,f);return h},coordL93ToWgs84:function(a,k){var c=new OpenLayers.Projection("EPSG:2154"),h=new OpenLayers.Projection("EPSG:900913"),
f=new OpenLayers.Geometry.Point(a,k);f.transform(c,h);return f},toLiterary:function(a){var c=String(a);return(a=l[c])?a:c},getEmSize:function(a){return Number(getComputedStyle(a,"").fontSize.match(/\d*\.?\d*/)[0])}}}();feed.shell=function(){var a={sidebar:{opened:!0,closed:!0},tab:{home:!0,report:!0,create:!0,settings:!0}},k={anchor_map:{}},e,l,h,c,f,n,q,m,g,v,w;h=function(){return $.extend(!0,{},k.anchor_map)};c=function(){var a=k.$container;e=a;l=a.find(".feed-shell-acct");a.find(".feed-shell-nav")};w=function(a){var c=h(),g=!0,f,e;a:for(f in a)if(a.hasOwnProperty(f)){if(0===f.indexOf("_"))continue a;c[f]=a[f];e="_"+f;a[e]?c[e]=a[e]:(delete c[e],delete c["_s"+e])}try{$.uriAnchor.setAnchor(c)}catch(x){$.uriAnchor.setAnchor(k.anchor_map,
null,!0),g=!1}return g};f=function(a){var c;a=!0;var f=h();try{c=$.uriAnchor.makeAnchorMap()}catch(p){return $.uriAnchor.setAnchor(f,null,!0),!1}k.anchor_map=c;switch(c.sidebar){case "opened":a=feed.sidebar.setSliderPosition("opened",c.tab);feed.map.setMarkerPosition("opened",c.tab);break;case "closed":a=feed.sidebar.setSliderPosition("closed",c.tab);feed.map.setMarkerPosition("closed",c.tab);break;default:feed.sidebar.setSliderPosition("closed",c.tab),delete c.sidebar}a||(f?($.uriAnchor.setAnchor(f,
null,!0),k.anchor_map=f):(delete c.sidebar,$.uriAnchor.setAnchor(c,null,!0)));return!1};n=function(a){feed.model.people.get_user().get_is_anon()?(a=prompt("Please sign-in"),feed.model.people.login(a),l.text("... processing ...")):feed.model.people.logout();return!1};q=function(a,c){l.text(c.name)};m=function(a,c){l.text("Please sign-in")};g=function(a){return w(a)};v=function(a){return w(a)};return{initModule:function(h,t,r){var p="doc/";k.$container=h;c();$.uriAnchor.configModule({schema_map:a});
t._leaflet_id||(p="/media/doc/");feed.sidebar.configModule({set_sidebar_anchor:g,sidebar_model:feed.model.sidebar,people_model:feed.model.people,reports_model:feed.model.reports,doc_path:p});feed.sidebar.initModule(e);feed.map.configModule({set_map_anchor:v,map_model:feed.model.map,people_model:feed.model.people,reports_model:feed.model.reports,doc_path:p});feed.map.initModule(t);$(window).bind("hashchange",f).trigger("hashchange");$.gevent.subscribe(h,"feed-login",q);$.gevent.subscribe(h,"feed-logout",
m);l.text("Please sign-in").bind("utap",n);r&&feed.model.people.login(r)}}}();feed.sidebar=function(){var a={main_html:String()+'<div id="sidebar" class="sidebar collapsed" style="font-size:12px;"><ul class="sidebar-tabs" role="tablist"><li id="t_home" class="tab" title="Liste"><a href="#" role="tab"><i class="fa fa-bars" aria-hidden="true"></i></a></li><li id="t_report" class="tab" title="Modifier"><a href="#" role="tab"><i class="fa fa-gear" aria-hidden="true"></i></a></li><li id="t_create" class="tab" title="Cr&eacute;er"><a href="#" role="tab"><i class="fa fa-plus" aria-hidden="true"></i></a></li><li id="t_settings" class="tab" title="Aide"><a href="#" role="tab"><i class="fa fa-info" aria-hidden="true"></i></a></li></ul><div class="sidebar-content feed-sidebar-content active"><div class="sidebar-pane feed-sidebar-content-home active" id="home"><h1>Liste des rapports</h1><div class="feed-sidebar-content-home-box"></div><div class="feed-sidebar-content-home-buttons"><button type="update" class="btn btn-primary btn-sm list-refresh" title="mettre la liste &agrave; jour">Rafraichir</button><a type="button" class="btn btn-primary btn-sm list-download" title="T&eacute;l&eacute;charger la liste au format csv">T&eacute;l&eacute;charger</a></div></div><div class="sidebar-pane feed-sidebar-content-report" id="report"><h1>Rapport &agrave; modifier</h1><h4 class="bg-danger is_selected">Veuillez s\u00e9lectionner un rapport dans la liste</h4><form class="feed-sidebar-content-report-form" id="form_modify"><div class="form-group feed-sidebar-content-report-form-group-head"><h5><label class="col-md-4 control-label">Rapport&nbsp;&nbsp;&nbsp;</label><label class="col-md-7 control-label feed-sidebar-content-report-form-id"> - </label></h5><label class="col-md-2 control-label">Cr\u00e9ation: </label><div class="col-md-4"><p class="form-control-static feed-sidebar-content-report-form-datecreate"></p></div><label class="col-md-3 control-label">Modification: </label><div class="col-md-3"><p class="form-control-static feed-sidebar-content-report-form-datemodif"></p></div><label class="col-md-2 control-label">Auteur: </label><div class="col-md-10"><p class="feed-sidebar-content-report-form-autor"></p></div></div><div class="form-group"><label class="col-md-12 control-label form-label-priority">Statut</label><select class="form-control feed-sidebar-content-report-form-statu"><option value="ATTENTE">'+
feed.util_b.toLiterary("ATTENTE")+'</option><option value="COURS">'+feed.util_b.toLiterary("COURS")+'</option><option value="TRAITE">'+feed.util_b.toLiterary("TRAITE")+'</option><option value="REJETE">'+feed.util_b.toLiterary("REJETE")+'</option></select></div><div class="form-group"><label class="col-md-12 control-label form-label-type_r">Type de rapport</label><select class="form-control feed-sidebar-content-report-form-type_r" data-validation="required"><option value="" disabled selected hidden>Vous souhaitez signaler ...</option><option value="PROBLEME">'+
feed.util_b.toLiterary("PROBLEME")+'</option><option value="ERREUR">'+feed.util_b.toLiterary("ERREUR")+'</option></select></div><div class="form-group"><label class="col-md-12 control-label form-label-type_e">Type d\'&eacute;quipement</label><input type="text" class="form-control form-type_e feed-sidebar-content-report-form-type_e required" id="type_e" placeholder="Ex: piste, citerne, PBI, route, b&acirc;timent, barri&egrave;re..." data-validation="required" >\x3c!-- <p class="help-block">In addition to freeform text, any HTML5 text-based input appears like so.</p> --\x3e</div><div class="form-group"><label class="col-md-12 control-label form-label-id_equi">Identifiant de l\'&eacute;quipement</label><input type="text" class="form-control form-id_equi feed-sidebar-content-report-form-id_equi required" id="id_equi" placeholder="Ex: AL 123" data-validation="required" ></div><div class="form-group"><label for="report-textarea" class="col-md-12 control-label form-label-description">Description</label><textarea id="report-textarea" class="form-control feed-sidebar-content-report-form-textarea" rows="3"></textarea></div><div id="feed-sidebar-content-report-statusdiv"><label class="col-md-12 control-label form-label-id_equi">Historique du Statut</label><table id="feed-sidebar-content-report-statushistory" class="table table-condensed table-striped" cellspacing="0" width="100%" role="grid" style="width: 100%;"><thead><tr><th class="control-label"><b>Statut</b></th><th><b>Date</b></th><th><b>Auteur</b></th></tr></thead><tbody></tbody></table></div><div class="form-group feed-sidebar-content-report-group-loc"><label class="col-md-12 control-label form-label-localisation">Localisation</label><p class="help-block">D\u00e9placez lic\u00f4ne pour modifier la localisation du rapport.</p><input type="text" class="col-md-5 feed-sidebar-content-report-form-x form-coord" id="x" placeholder="Longitude" readonly><input type="text" class="col-md-5 col-md-offset-2 feed-sidebar-content-report-form-y form-coord" id="y" placeholder="Latitude" readonly></div><div class="form-group form-group-action"><label class="col-md-12 control-label form-label-action">Action</label><select class="form-control feed-sidebar-content-report-form-action"><option value="INFO">'+
feed.util_b.toLiterary("INFO")+'</option><option value="CREATION">'+feed.util_b.toLiterary("CREATION")+'</option><option value="MODIF">'+feed.util_b.toLiterary("MODIF")+'</option><option value="DEPLACE">'+feed.util_b.toLiterary("DEPLACE")+'</option><option value="SUPRIME">'+feed.util_b.toLiterary("SUPRIME")+'</option></select></div><div class="form-group form-group-cible"><label class="col-md-12 control-label form-label-cible">Cible</label><select class="form-control feed-sidebar-content-report-form-cible"><option value="SDIS">'+
feed.util_b.toLiterary("SDIS")+'</option><option value="BMPM">'+feed.util_b.toLiterary("BMPM")+'</option><option value="ONF">'+feed.util_b.toLiterary("ONF")+'</option><option value="DDTM">'+feed.util_b.toLiterary("DDTM")+'</option><option value="DFCI">'+feed.util_b.toLiterary("DFCI")+'</option><option value="CD">'+feed.util_b.toLiterary("CD")+'</option><option value="AUTRE">'+feed.util_b.toLiterary("AUTRE")+'</option></select></div><div class="form-group"><a class="btn btn-primary btn-sm report-send">Transmettre</a><button class="btn btn-primary btn-sm report-modify">Modifier</button><button class="btn btn-primary btn-sm report-cancel">Annuler</button></div></form><div class="form-group"><label class="control-label feed-sidebar-content-report-form-doc-label"></label><span class="glyphicon glyphicon-remove g-delete feed-sidebar-content-report-form-group-doc-delete" aria-hidden="true"></span></div><div class="form-group feed-sidebar-content-report-form-group-doc-create"><p class="help-block">Ajouter un fichier: </p><span class="btn btn-primary btn-sm fileinput-button"><i class="glyphicon glyphicon-plus"></i><span>S&eacute;lectionnez un fichier...</span><input id="fileupload" type="file" name="files[]" data-url="../feed/"></input></span><div id="result"></div><button class="btn btn-primary btn-sm fileinput-upload" /><div id="progress"><div class="bar" style="width: 0%;"></div></div></div></div><div class="sidebar-pane feed-sidebar-content-create" id="create"><h1>Cr&eacute;er un rapport</h1><form class="feed-sidebar-content-create-form" id="form_create" name="create_form"><div class="form-group"><label class="col-md-12 control-label form-label-type_r">Type de rapport</label><select class="form-control feed-sidebar-content-create-form-type_r required" data-validation="required"><option value="" disabled selected hidden>Vous souhaitez signalez ...</option><option value="PROBLEME">'+
feed.util_b.toLiterary("PROBLEME")+'</option><option value="ERREUR">'+feed.util_b.toLiterary("ERREUR")+'</option></select></div><div class="form-group"><label class="col-md-12 control-label form-label-type_e">Type d\'&eacute;quipement</label><input type="text" class="form-control form-type_e feed-sidebar-content-create-form-type_e required" id="type_e" placeholder="Ex: piste, citerne, PBI, route, b&acirc;timent, barri&egrave;re..." data-validation="required" >\x3c!-- <p class="help-block">In addition to freeform text, any HTML5 text-based input appears like so.</p> --\x3e</div><div class="form-group"><label class="col-md-12 control-label form-label-id_equi">Identifiant de l\'&eacute;quipement</label><input type="text" class="form-control form-id_equi feed-sidebar-content-create-form-id_equi required" id="id_equi" placeholder="Ex: AL 123" data-validation="required" ></div><div class="form-group"><label for="create-textarea" class="col-md-12 control-label form-label-description">Description</label><textarea id="create-textarea" class="form-control feed-sidebar-content-create-form-textarea" rows="3" placeholder="Veuillez pr\u00e9ciser l\'anomalie rencontr\u00e9e"></textarea></div><div class="form-group feed-sidebar-content-create-group-locate"><label class="col-md-12 control-label form-label-localisation">Localisation</label><p class="help-block">D\u00e9placez la carte pour modifier la localisation du rapport.</p><input type="text" class="col-md-5 feed-sidebar-content-create-form-x form-coord" id="xCreate" placeholder="Longitude" readonly data-validation="required" ><input type="text" class="col-md-5 col-md-offset-2 feed-sidebar-content-create-form-y form-coord" id="yCreate" placeholder="Latitude" readonly data-validation="required" ></div><div class="form-group"><label class="control-label feed-sidebar-content-create-form-doc-label"></label><span class="glyphicon glyphicon-remove g-delete feed-sidebar-content-create-form-group-doc-delete" aria-hidden="true"></span></div><div class="form-group feed-sidebar-content-create-form-group-doc-create"><p class="help-block">Ajouter un fichier: </p><span class="btn btn-primary btn-sm fileinput-button"><i class="glyphicon glyphicon-plus"></i><span>S&eacute;lectionnez un fichier...</span><input id="fileuploadCreate" type="file"></input></span><div id="result"></div><button class="btn btn-primary btn-sm fileinput-upload" /><div id="progress"><div class="bar" style="width: 0%;"></div></div></div><div class="form-group"><button class="btn btn-primary btn-sm report-create">Cr&eacute;er</button><button type="reset" class="btn btn-primary btn-sm reset">Annuler</button><p class="help-block"><b>*</b> champs obligatoires</p></div></form></div><div class="sidebar-pane" id="settings"><h1>L\'application en quelques mots...</h1><p>Chaque rapport cr&eacute;&eacute; est consultable par tous les autres utilisateurs de l\'application.</p><p>Un rapport est modifiable par son cr&eacute; tant que son statut est &laquo; en attente &raquo;.</p><p>L\'administrateur de l\'application consigne et signale aux gestionnaires concern&eacute;s l\'information contenue dans le rapport afin de proc&eacute;der aux correctifs &agrave; apporter.</p><p>L\'\u00e9tat d\'avancement du traitement de l\'information est actualis&eacute; en temps r&eacute;el par l\'administrateur au moyen d\'un jeu de couleurs:<ul style="list-style-type:none"><li>- <span class="feed-sidebar-content-list-td-statu-attente"><b>rouge</b></span>: en attente</li><li>- <span class="feed-sidebar-content-list-td-statu-cours"><b>Jaune</b></span>: en cours de traitement</li><li>- <span class="feed-sidebar-content-list-td-statu-traite"><b>Vert</b></span>: trait&eacute;</li><li>- <span class="feed-sidebar-content-list-td-statu-rejete"><b>Gris</b></span>: rejet&eacute;</li></ul></p><p>Les &eacute;l&eacute;ments &laquo; trait&eacute;s &raquo; seront int&eacute;gr&eacute;s &agrave; la cartographie au moment de la mise &agrave; jour du site:<br>- annuelle pour les donn\u00e9es DFCI<br>- hebdomadaire pour les donnn\u00e9es urbaines</p><p>Le ou les administrateurs sont &agrave; votre disposition &agrave; l\'adresse: <a href="mailto:#" class="feed-sidebar-content-help-email">contact.admin13@valabre.com</a></p></div></div><div class="modal fade feed-sidebar-modal-img" id="modalImg" tabindex="-1" role="dialog" aria-labelledby="modal-img-title">  <div class="modal-dialog modal-lg" role="document">   <div class="modal-content">     <div class="modal-body">         <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>         <h4 class="feed-sidebar-modal-img-title" id="modal-img-title"></h4>         <img class="img img-responsive img-thumbnail feed-sidebar-modal-img-body-img center-block" alt="No image" src="">     </div>   </div> </div></div><div class="modal fade feed-sidebar-modal-message" id="modalMess" tabindex="-1" role="dialog" data-backdrop="false" aria-labelledby="modal-img-title">  <div class="modal-dialog" role="document">   <div class="modal-content">     <div class="modal-header feed-sidebar-modal-message-header bg-primary">         <h4 class="feed-sidebar-modal-message-title" id="modalMessTitle">Message</h4>     </div>     <div class="bg-default modal-body">         <strong><p class="feed-sidebar-modal-message-body-p"></p></strong>     </div>   </div> </div></div></div>\x3c!-- http://formvalidator.net/index.html --\x3e <script>$.validate({language : {requiredFields: "Champ obligatoire."}});\x3c/script>',
settable_map:{sidebar_model:!0,people_model:!0,reports_model:!0,set_sidebar_anchor:!0,doc_path:!0},sidebar_model:null,people_model:null,reports_model:null,set_content_anchor:null},k=null,e=null,l="closed",h=null,c=null,f="bg-primary",n,q,m,g,v,w,y,t,r,p,C,x,E,H,F,G,z,A,d,u,B,b,L,T,D,qa,J,ra,sa,M,N,U,V,aa,W,ba,ca,da,ta,O,P,X,ea,fa,ua,ga,ha,K,va,wa,ia,ja,ka,xa,ya,la,za,Q,R,Y,Aa,S,Z,ma,na,Ba,Ca,Da,oa,Ea,Fa,Ga,Ha,Ia,Ja,pa,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa;la=function(){var a=[];$("#tableReports").find("tr").each(function(I){$(this).attr("tr-id")&&
a.push($(this).attr("tr-id"))});return a};za=function(){var a=k.find(".sidebar");n=a;q=a.find(".tab");m=a.children(".sidebar-content").first();g=a.find(".feed-sidebar-content-home-box");v=a.find(".feed-sidebar-content-report-form");w=a.find(".feed-sidebar-content-report-form .form-group");y=a.find(".feed-sidebar-content-report-form-id");t=a.find(".feed-sidebar-content-report-form-id_equi");r=a.find(".feed-sidebar-content-report-form-textarea");p=a.find(".feed-sidebar-content-report-form-statu");C=
a.find(".feed-sidebar-content-report-form-type_r");x=a.find(".feed-sidebar-content-report-form-type_e");E=a.find(".feed-sidebar-content-report-form-action");H=a.find(".form-group-cible");F=a.find(".form-group-action");G=a.find(".feed-sidebar-content-report-form-cible");z=a.find(".feed-sidebar-content-report-form-datecreate");A=a.find(".feed-sidebar-content-report-form-datemodif");d=a.find(".feed-sidebar-content-report-form-autor");u=a.find("#feed-sidebar-content-report-statusdiv");B=a.find("#feed-sidebar-content-report-statushistory");
b=a.find(".feed-sidebar-content-report-form-x");L=a.find(".feed-sidebar-content-report-form-y");T=a.find(".feed-sidebar-content-report-form-doc-label");D=a.find(".feed-sidebar-content-report-form-group-doc-create");qa=a.find(".feed-sidebar-content-report-form-file");J=a.find(".feed-sidebar-content-report-form-group-doc-delete");ra=a.find("#fileupload");sa=a.find("#fileuploadCreate");M=a.find(".fileinput-upload");N=a.find("#progress .bar");U=a.find(".feed-sidebar-content-create-form");a.find(".feed-sidebar-content-create-form .form-group");
V=a.find(".feed-sidebar-content-create-form-id_equi");aa=a.find(".feed-sidebar-content-create-form-textarea");W=a.find(".feed-sidebar-content-create-form-type_r");ba=a.find(".feed-sidebar-content-create-form-type_e");ca=a.find(".feed-sidebar-content-create-form-doc-label");da=a.find(".feed-sidebar-content-create-form-group-doc-create");ta=a.find(".feed-sidebar-content-create-form-file");O=a.find(".feed-sidebar-content-create-form-group-doc-delete");P=a.find(".feed-sidebar-content-create-form-x");
X=a.find(".feed-sidebar-content-create-form-y");ea=a.find(".is_selected");fa=a.find(".feed-sidebar-content-help-email");ua=a.find(".list-refresh");ga=a.find(".list-download");ha=a.find(".report-send");K=a.find(".report-modify");va=a.find(".report-cancel");wa=a.find(".report-create");ia=a.find(".feed-sidebar-modal-img-title");ja=a.find(".feed-sidebar-modal-img-body-img");ka=a.find(".feed-sidebar-modal-message");xa=a.find(".feed-sidebar-modal-message-header");a.find(".feed-sidebar-modal-message-title");
ya=a.find(".feed-sidebar-modal-message-body-p")};Q=function(a,b){var d="bg-"+b.type;d!=f&&(xa.toggleClass(f+" "+d),f=d);ya.html(feed.util_b.encodeHtml(b.text));ka.modal("show");setTimeout(function(){ka.modal("hide")},3500)};R=function(){y.html(" - ");t.val("").attr("placeholder","Ex: AL 123");r.val("");p.val("");C.val("");x.val("").attr("placeholder","Ex: piste, citerne, PBI, route, b\u00e2timent, barri\u00e8re...");z.html(" - ");A.html(" - ");d.html("");b.val("").attr("placeholder","Longitude");
L.val("").attr("placeholder","Latitude");u.hide();qa.val("").attr("placeholder","No file");ea.show();c=null;Y();ia.val("");ja.attr("src","");S()};Y=function(){V.val("").attr("placeholder","Ex: AL 123");aa.val("");W.val("");ba.val("").attr("placeholder","Ex: piste, citerne, PBI, route, b\u00e2timent, barri\u00e8re...");P.val("").attr("placeholder","Longitude");X.val("").attr("placeholder","Latitude");ta.val("").attr("placeholder","No file");e=null;ma()};Aa=function(){g.html("No report to display")};
S=function(){v.get(0).reset();U.get(0).reset()};Z=function(a){M.hide();ra.fileupload({dataType:"json",add:Sa,progress:function(a,b){var d=parseInt(b.loaded/b.total*100,10);N.css("width",d+"%")},done:Ta})};ma=function(b){M.hide();sa.fileupload({url:"../feed/",dataType:"json",loadImageFileTypes:"/^image/(gif|jpeg|png)$/",loadImageMaxFileSize:1E3,add:function(a,b){e=b;ca.html(b.files[0].name);da.hide();O.show()},progress:function(a,b){var d=parseInt(b.loaded/b.total*100,10);N.css("width",d+"%")},done:function(b,
d){N.css("width","0%");a.sidebar_model.update_list([d._response.result]);oa()}})};na=function(b){var d=!0,I;I=$(b.currentTarget);b=h;if(!I.hasClass("tab"))return!1;I=I[0].id.split("t_")[1];"opened"===l&&I===b&&(d=!1);a.set_sidebar_anchor({sidebar:d?"opened":"closed",tab:I});return!1};Ba=function(d){a.people_model.get_user().get_is_anon()?(Q(null,{text:"Veuillez vous logger !",type:"warning"}),R(),Aa()):w.children(".has-error").length?(Q(null,{text:"Veuillez compl\u00e9ter le formulaire !",type:"warning"}),
d.preventDefault()):b.val()&&t.val()&&(c?(d=feed.util_b.coordL93ToWgs84(b.val(),L.val()),a.reports_model.update_({_id:c,locate_map:{x:d.x.toFixed(0),y:d.y.toFixed(0)},id_equi:t.val(),textarea:r.val(),statu:p.val(),type_r:C.val(),type_e:x.val(),action:E.val(),cible:G.val()})):(Q(null,{text:"Veuillez s\u00e9lectionner un rapport dans la liste !",type:"warning"}),d.preventDefault()))};Sa=function(b,d){d.formData={report_id:c};a.reports_model.upload_(d)};Ta=function(d,b){M.hide();b.context=M.text("").replaceAll("#result");
N.css("width","0%");a.sidebar_model.update_list([b._response.result])};Ea=function(a){a=$(a.target);if(!a.hasClass("g-popup"))return!1;a=a.attr("gly-id");$.gevent.publish("feed-displayinfo",a)};Da=function(b){b=$(b.target);if(!b.hasClass("g-remove"))return!1;b=b.attr("gly-id");if(!b)return!1;a.sidebar_model.set_report(b);confirm("Voulez-vous supprimer ce rapport ?")&&a.reports_model.delete_(b)};Ca=function(b){b=$(b.target);if(!b.hasClass("g-edit"))return!1;b=b.attr("gly-id");if(!b)return!1;b!==c&&
(S(),a.sidebar_model.set_report(b));a.set_sidebar_anchor({sidebar:"opened",tab:"report"});return!1};Fa=function(b){c&&(S(),a.reports_model.cancel_(c))};Ga=function(b){var d;P.val()&&V.val()&&(b=feed.util_b.coordL93ToWgs84(P.val(),X.val()),d=e,a.reports_model.create_({locate_map:{x:b.x.toFixed(0),y:b.y.toFixed(0)},id_equi:V.val(),textarea:aa.val(),type_r:W.val(),type_e:ba.val(),doc:d}),a.set_sidebar_anchor({sidebar:"opened",tab:"home"}))};Ha=function(b){confirm("Voulez-vous supprimer ce document ?")&&
(a.reports_model.delete_doc_(c),T.html(""),J.hide(),D.show(),Z(c))};oa=function(a){ca.html("");O.hide();da.show();e=null;ma()};Ja=function(a){$.gevent.publish("feed-selectstatu",$(a).val())};Ia=function(b){b=$(b.elem_target.parentNode);if(!b.hasClass("feed-sidebar-content-list-name"))return!1;b=b.attr("tr-id");if(!b||b===c)return!1;a.sidebar_model.set_report(b);return!1};pa=function(b,d){var c;ia.html(d);(c=a.reports_model.get_by_cid(d))&&/\.(gif|jpg|jpeg|tiff|png)$/i.test(c.doc)&&ja.attr("src",c.doc);
return!1};Ka=function(b){a.sidebar_model.get_list()};Wa=function(b){b=la();var d=$("#tableReports").DataTable().rows().ids().length;d&&(d===b.length&&(b=[]),a.sidebar_model.down_list(b))};La=function(f,k){var h,e=k.new_report,l=a.people_model.get_user().rules_map.update_;if(e.get_is_empty())return R(),!1;g.find(".feed-sidebar-content-list-name").removeClass("feed-x-select").end().find("[tr-id="+e.id+"]").addClass("feed-x-select");S();ea.hide();c=e.id;y.html(e.id);t.val(e.id_equi);r.val(e.textarea);
p.val(e.statu);C.val(e.type_r);x.val(e.type_e);E.val(e.action);G.val(e.cible);z.html(e.created);A.html(e.modified);d.html(e.owner);e.history_status&&0<e.history_status.length?(B.DataTable({data:e.history_status,paging:!1,ordering:!1,searching:!1,info:!1,destroy:!0,createdRow:function(a,b,d){switch(b[0]){case "REJETE":$("td:eq(0)",a).html(feed.util_b.toLiterary("REJETE"));break;case "COURS":$("td:eq(0)",a).html(feed.util_b.toLiterary("COURS"));break;case "TRAITE":$("td:eq(0)",a).html(feed.util_b.toLiterary("TRAITE"));
break;default:$("td:eq(0)",a).html(feed.util_b.toLiterary("ATTENTE"))}},language:{emptyTable:"Aucun \u00e9l\u00e9ment \u00e0 afficher"}}),u.show()):u.hide();h=feed.util_b.coordWgs84ToL93(e.locate_map.x,e.locate_map.y);b.val(h.x.toFixed(0));L.val(h.y.toFixed(0));l||"ATTENTE"==p.val()?(K.prop("disabled",!1),K.attr("title","Envoyer la modification")):(K.prop("disabled",!0),K.attr("title","Seul l'administrateur a les droits de modification"));e.doc?(T.html('<a href="/media/'+e.doc+'" target="_blank">'+
e.doc+"</a>"),D.hide(),(l||"ATTENTE"==p.val())&&J.show(),Z(null)):(T.html(""),J.hide(),Z(e.id),(l||"ATTENTE"==p.val())&&D.show());ha.attr("href","mailto:?subject=Remont\u00e9e d'informations - Rapport "+e.id+" \u00e0 votre attention&body=Bonjour,%0D%0ALe rapport "+e.id+" r\u00e9dig\u00e9 dans l'application G\u00e9o DFCI (http://www.sig-dfci.org) vous est destin\u00e9.%0D%0AMerci de prendre en compte cette information et de me faire part, par retour de mail, de l'\u00e9tat d'avancement de ce dossier.%0D%0A%0D%0AVous en remerciant par avance et restant \u00e0 votre disposition.%0D%0ACordialement,%0D%0A%0D%0AL'administrateur SIG-DFCI");
Y();pa(null,e.id);return!0};Ma=function(b){var d,e;b=a.people_model.get_user();var u=!1;e=a.reports_model.get_db();var f=String();d=b.rules_map.update_;f+='<div class="table-responsive"><table id="tableReports" class="table table-striped table-hover" cellspacing="0" width="100%" role="grid" style="width: 100%;"><thead><tr><th>ID</th><th>Statut</th><th>Modif.</th><th>&Eacute;quip.</th><th></th><th></th>';d&&(f+="<th></th><th></th><th></th>");f+="</tr></thead><tbody>";e().each(function(a,b){var e="",
h="";a.statu&&(h=feed.util_b.encodeHtml(p.find("option[value="+a.statu+"]").val()));a.type_r&&feed.util_b.encodeHtml(W.find("option[value="+a.type_r+"]").val());if(a.get_is_empty())return!0;c&&c===a.id&&(e=" feed-x-select");f+='<tr class="feed-sidebar-content-list-name'+e+'" tr-id="'+a.id+'"><td data-id="'+a.id+'">'+a.id+'</td><td class="feed-sidebar-content-list-td-statu-'+a.statu.toLowerCase()+'"><strong>'+h+'</strong></td><td scope="row">'+feed.util_b.encodeHtml(a.modified)+"</td><td>"+feed.util_b.encodeHtml(a.type_e)+
'</td><td><span class="glyphicon glyphicon-list g-popup" gly-id="'+a.id+'" aria-hidden="true" title="afficher"></span></td><td>'+a.owner+"</td>";d&&(f+='<td><span class="glyphicon glyphicon-cog g-edit" gly-id="'+a.id+'" aria-hidden="true" title="modifier"></span></td><td><span class="glyphicon glyphicon-remove g-remove" gly-id="'+a.id+'" aria-hidden="true" title="supprimer"></span></td></td><td class="text-center feed-sidebar-content-list-td-mailto"><a href="mailto:'+a.owner+"&subject=Remont\u00e9e d'informations - Rapport "+
a.id+'&body=Message de l\'administrateur" title="'+a.owner+'" class="fa fa-envelope tltip" data-toggle="tooltip" data-placement="left"></a></td>');f+="</tr>";u=!0});f+="</tbody></table></div>";u||(f=String()+'<div class="spa-chat-list-note text-right"><h5>Aucun rapport &agrave; afficher !</h5></div>',R());g.html(f);n.find(".g-popup").bind("click",Ea);n.find(".g-remove").bind("click",Da);n.find(".g-edit").bind("click",Ca);g.find("tr").bind("mouseover",Na);g.find("tr").bind("mouseout",Oa);e=d?[null,
null,null,null,{orderable:!1},{visible:!1},{orderable:!1},{orderable:!1},{orderable:!1}]:[null,null,null,null,{orderable:!1},{visible:!1}];$("#tableReports").DataTable({dom:'<"top"f>rt<"bottom"ip><"clear">',autoWidth:!0,pageLength:14,language:{url:"//cdn.datatables.net/plug-ins/1.10.11/i18n/French.json"},order:[[0,"desc"]],columns:e}).on("search.dt",function(a,b){setTimeout(function(){var a=la();$("#tableReports").DataTable().rows().ids().length===a.length&&(a=[]);$.gevent.publish("feed-search",[a])},
1E3)});fa.html(b.admins);fa.attr("href","mailto:"+b.admins);Y();return!1};Na=function(a){a=$(a.currentTarget);if(!a.hasClass("feed-sidebar-content-list-name"))return!1;a=a.attr("tr-id");if(!a)return!1;$.gevent.publish("feed-listhover",a)};Oa=function(a){$.gevent.publish("feed-listhover","")};Pa=function(a,b){b?g.find("[tr-id="+b+"]").addClass("tr-selected"):g.find("tr").removeClass("tr-selected")};Qa=function(a,b){var d=feed.util_b.coordWgs84ToL93(b.x,b.y);P.val(d.x.toFixed(0));X.val(d.y.toFixed(0))};
Ra=function(a,d){var c=feed.util_b.coordWgs84ToL93(d.x,d.y);b.val(c.x.toFixed(0));L.val(c.y.toFixed(0))};Ua=function(b,d){a.people_model.get_user().rules_map.update_||(p.prop("disabled",!0),F.hide(),H.hide(),ha.hide(),ga.hide())};Va=function(b,d){a.set_sidebar_anchor({sidebar:"closed"});R()};return{setSliderPosition:function(a,b,d){switch(a){case "opened":n.trigger("opening");n.removeClass("collapsed");q.removeClass("active").filter("#t_"+b).addClass("active");m.find(".sidebar-pane").removeClass("active").end().find("#"+
b).addClass("active");$("#tableReports").DataTable().draw();break;case "hidden":break;case "closed":n.trigger("closing").addClass("collapsed");q.removeClass("active");break;default:return!1}l=a;h=b;d&&d(n);return!0},removeSlider:function(a){n&&(a?(n.hide(),$.gevent.publish("feed-removeslider",!0)):(n.show(),$.gevent.publish("feed-removeslider",!1)));return!0},handleResize:void 0,configModule:function(b){feed.util.setConfigMap({input_map:b,settable_map:a.settable_map,config_map:a});return!0},initModule:function(b){k=
b;b.append(a.main_html);za();q.click(na);l="closed";b=g;$.gevent.subscribe(b,"feed-listchange",Ma);$.gevent.subscribe(b,"feed-setreport",La);$.gevent.subscribe(b,"feed-login",Ua);$.gevent.subscribe(b,"feed-logout",Va);$.gevent.subscribe(b,"feed-hover",Pa);$.gevent.subscribe(b,"feed-clickmarker",pa);$.gevent.subscribe(b,"feed-alert",Q);$.gevent.subscribe(U,"feed-coord",Qa);$.gevent.subscribe(U,"feed-setcoord",Ra);q.bind("utap",na);b.bind("utap",Ia);ua.bind("click",Ka);ga.bind("click",Wa);K.bind("click",
Ba);va.bind("click",Fa);wa.bind("click",Ga);J.bind("click",Ha);O.bind("click",oa);p.selected(function(a){Ja(a)});J.hide();O.hide();D.hide();u.hide()}}}();feed.map=function(){var a={settable_map:{map_model:!0,people_model:!0,reports_model:!0,set_map_anchor:!0,doc_path:!0},map_model:null,people_model:null,reports_model:null,set_content_anchor:null},k=null,e=null,l=null,h=null,c=null,f=null,n=null,q=!1,m={},g,v,w,y,t,r,p,C,x,E,H,F,G,z,A;g=function(){var d,c,g,b,n,p,D,v=e;d=new OpenLayers.Size(21,25);new OpenLayers.Pixel(-(d.w/2),-d.h);n=(n=OpenLayers.Util.getParameters(window.location.href).renderer)?[n]:OpenLayers.Layer.Vector.prototype.renderers;d=
new OpenLayers.Style({graphicWidth:24,graphicHeight:24,pointRadius:10,zIndex:100,title:"${tooltip}"});g=new OpenLayers.Style(OpenLayers.Util.applyDefaults({pointRadius:5,zIndex:50,graphicWidth:14,graphicHeight:14},OpenLayers.Feature.Vector.style["default"]));d=new OpenLayers.StyleMap({"default":{backgroundGraphic:"/static/libs/feedback/src/img/marker_shadow.png",backgroundXOffset:0,backgroundYOffset:-7,backgroundGraphicZIndex:10,graphicZIndex:11,pointRadius:10,cursor:"pointer",title:"${tooltip}"},
over:d,selected:g});c=new OpenLayers.StyleMap({"default":{graphicName:"cross",strokeColor:"red",fillColor:"yellow",fillOpacity:.8,zIndex:2E3,pointRadius:12,rotation:45},over:{fillOpacity:1,cursor:"grab",rotation:0}});b=new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults({fillColor:"#ff0000",fillOpacity:1,pointRadius:11,graphicZIndex:2E3},OpenLayers.Feature.Vector.style.select)});g=new OpenLayers.Layer.Vector("layer_markers",{renderers:n,eventListeners:{featureclick:function(a){h&&(h.id!==
a.feature.popup.id?r():(m.$click_feature.unselectAll(),f=null));a.feature.popup.toggle();a.feature.popup.visible()&&(h=a.feature.popup);return!1},nofeatureclick:function(a){r()},featureover:function(a){var b=a.feature,d=b.attributes.id;"default"==b.renderIntent&&(a.feature.renderIntent="over",a.feature.layer.drawFeature(a.feature));q&&l&&l.attributes.id===d?p.activate():p.deactivate();$.gevent.publish("feed-hover",d)},featureout:function(a){"over"==a.feature.renderIntent&&(f?a.feature.id!==f.id&&
(a.feature.renderIntent="default",a.feature.layer.drawFeature(a.feature)):(a.feature.renderIntent="default",a.feature.layer.drawFeature(a.feature)));$.gevent.publish("feed-hover","")}}});c=new OpenLayers.Layer.Vector("layer_new",{renderers:n,styleMap:c,eventListeners:{featureover:function(a){D.activate()},featureout:function(a){D.deactivate()}}});n=new OpenLayers.Layer.Vector("layer_select",{renderers:n,styleMap:b});p=new OpenLayers.Control.DragFeature(g,{id:"dragmarkers",onStart:function(a,b){q&&
r()},onDrag:function(a,b){$.gevent.publish("feed-setcoord",{x:a.geometry.x.toFixed(0),y:a.geometry.y.toFixed(0)})},onComplete:function(b,d){var c,e={locate_map:{}};c=a.reports_model.get_by_cid(b.data.id);var f=feed.util_b.coordWgs84ToL93(b.geometry.x,b.geometry.y);m.$layer_select.destroyFeatures();e.id=b.data.id;e.locate_map.x=b.geometry.x.toFixed(0);e.locate_map.y=b.geometry.y.toFixed(0);c&&(e.id_equi=c.title,e.textarea=c.textarea,e.statu=c.statu,e.type_r=c.type_r,e.type_e=c.type_e,e.created=c.datecreate,
e.modified=c.modified,e.owner=c.owner,e.img=c.img,e.doc=c.doc);c=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(e.locate_map.x,e.locate_map.y));m.$layer_select.addFeatures([c]);b.popup.setContentHTML(t(e));b.popup.lonlat.lon=f.x.toFixed(0);b.popup.lonlat.lat=f.y.toFixed(0);this.deactivate()}});k.addControl(p);D=new OpenLayers.Control.DragFeature(c,{onDrag:function(a,b){$.gevent.publish("feed-coord",{x:a.geometry.x.toFixed(0),y:a.geometry.y.toFixed(0)})}});k.addControl(D);b=new OpenLayers.Control.SelectFeature(g,
{renderIntent:"over",clickout:!0,toggle:!0,multiple:!1});k.addControl(b);b.activate();k.addLayer(n);k.addLayer(c);k.addLayer(g);d.addUniqueValueRules("default","statu",{TRAITE:{externalGraphic:"/static/libs/feedback/src/img/marker-green.png"},COURS:{externalGraphic:"/static/libs/feedback/src/img/marker-gold.png"},REJETE:{externalGraphic:"/static/libs/feedback/src/img/marker-gray.png"},ATTENTE:{externalGraphic:"/static/libs/feedback/src/img/marker.png"}});g.styleMap=d;m={$layer_markers:g,$layer_new:c,
$layer_select:n,$map_div:v,$marker_list:[],$click_feature:b,$styleMarker:void 0}};v=function(a){var d=null;a&&(d=m.$marker_list[a]);return d};w=function(d){var c,e,b;d&&(c=v(d))&&(l=c,e=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(c.geometry.x,c.geometry.y)),m.$layer_select.addFeatures([e]),l.renderIntent="selected",m.$layer_markers.drawFeature(l),h=b=m.$marker_list[c.data.id].popup,(d=a.reports_model.get_by_cid(d))?(b=new OpenLayers.LonLat(d.locate_map.x,d.locate_map.y),c.move(b),
e.move(b),k.panTo([d.locate_map.x,d.locate_map.y])):k.panTo([c.geometry.x,c.geometry.y]))};y=function(){m.$layer_select.destroyFeatures();l&&(l.renderIntent="default",m.$layer_markers.drawFeature(l),l=null);r()};t=function(d){var c;c=a.people_model.get_user();var e=String();c=c.rules_map.update_;e+="<label>Rapport "+d.id+'</label><table class="table table-condensed feed-popup-content-head"><tbody><tr><td><label>Cr\u00e9ation</label></td><td>'+d.created+"</td></tr><tr><td><label>Modification</label></td><td>"+
d.modified+"</td></tr><tr><td><label>Auteur</label></td><td>"+d.owner+'</td></tr><tr><td><label>Statut</label></td><td class="feed-popup-content-statu-'+d.statu.toLowerCase()+'"><b>'+feed.util_b.toLiterary(d.statu)+'</b></td></tr></tbody></table><table class="table table-condensed feed-popup-content-body"><tbody><tr><td><label>Type de rapport:</label></td></tr><tr><td class="feed-popup-content-body-td-text">'+feed.util_b.toLiterary(d.type_r)+'</td></tr><tr><td><label>Type d\'\u00e9quipement:</label></td></tr><tr><td class="feed-popup-content-body-td-text">'+
d.type_e+'</td></tr><tr><td><label>Identifiant de l\'\u00e9quipement:</label></td></tr><tr><td class="feed-popup-content-body-td-text">'+d.id_equi+'</td></tr><tr><td class="feed-popup-content-body-td-label"><label>Description:</label></td></tr></tbody></table><p class="feed-popup-content-desc">'+d.textarea+"</p>";d.doc&&(e=/\.(gif|jpg|jpeg|tiff|png)$/i.test(d.doc)?e+('<a target="_blank" href="/media/'+d.doc+'"><img class="feed-map-popup-img img-responsive img-thumbnail center-block" alt="No image" src="/media/'+
d.doc+'"></a>'):e+('<div><a href="/media/'+d.doc+'" target="_blank">'+d.doc+"</a></div>"));c&&(e+='<table class="table table-condensed feed-popup-content-coord"><tbody><tr colspan="2"><td class="feed-popup-content-body-td-label"><label>Coordonn\u00e9es en Lambert 93</label></td></tr><tr><td>Lattitude</td><td>'+d.locate_map.y+"</td></tr><tr><td>Longitude</td><td>"+d.locate_map.x+"</td></tr></tbody></table>",e+='<table class="table table-condensed feed-popup-content-footer"><tbody><tr><td><label>Action</label></td><td>'+
feed.util_b.toLiterary(d.action)+"</td></tr><tr><td><label>Cible</label></td><td>"+feed.util_b.toLiterary(d.cible)+"</td></tr></tbody></table>");return e};r=function(){h&&(h.hide(),h=null)};p=function(a){for(var d=m.$layer_markers.features,c=0;c<d.length;c++){var b=d[c];-1===a.indexOf(b.attributes.id)&&(b.style={visibility:"hidden"})}m.$layer_markers.redraw()};C=function(){for(var a=m.$layer_markers.features,c=0;c<a.length;c++){var e=a[c];e.style&&(e.style=null)}m.$layer_markers.redraw()};x=function(a,
c){var d;y();k.getControl("dragmarkers").deactivate();c.new_report&&((d=v(c.new_report.id))&&w(d.attributes.id),c.new_report==c.old_report&&h&&(h.setContentHTML(t(c.new_report)),h.lonlat.lon=c.new_report.locate_map.x,h.lonlat.lat=c.new_report.locate_map.y));return!1};E=function(d){d=a.reports_model.get_db();var c=a.reports_model.get_current(),e=[];m.$layer_markers.removeAllFeatures();k.getControl("dragmarkers").deactivate();d().each(function(a,d){var b,c;c={locate_map:{}};c.id=a.id;c.locate_map.x=
a.locate_map.x;c.locate_map.y=a.locate_map.y;c.id_equi=a.id_equi;c.textarea=a.textarea;c.type_r=a.type_r;c.type_e=a.type_e;c.action=a.action;c.cible=a.cible;c.created=a.created;c.modified=a.modified;c.owner=a.owner;c.img=a.img;c.doc=a.doc;c.statu=a.statu;b=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a.locate_map.x,a.locate_map.y),{id:a.id,tooltip:a.id,statu:a.statu});c=new OpenLayers.Popup.FramedCloud(a.id,OpenLayers.LonLat.fromString(b.geometry.toShortString()),null,t(c),null,!0,
function(a){r()});c.panMapIfOutOfView=!1;c.maxSize=new OpenLayers.Size(450,600);c.keepInMap=!0;c.disableFirefoxOverflowHack=!0;b.popup=c;k.addPopup(b.popup);b.popup.hide();e.push(b);m.$marker_list[a.id]=b});m.$layer_markers.addFeatures(e);m.$layer_markers.redraw();c&&w(c.id);return!1};H=function(a,e){var d,b=!1;e?(d=v(e),l?d&&d.id!==l.id?b=!0:c=d:b=!0):c&&(l?c.id!==l.id&&(c.renderIntent="default",m.$layer_markers.drawFeature(c),m.$click_feature.unselectAll()):(c.renderIntent="default",m.$layer_markers.drawFeature(c),
m.$click_feature.unselectAll()),c=null);b&&(d.renderIntent="over",m.$layer_markers.drawFeature(d),c=d)};F=function(a,c){m.$layer_markers.clearLayers()};G=function(a,c){c?(k.removeLayer(m.$layer_markers),k.removeLayer(m.$layer_new),k.removeLayer(m.$layer_select),r()):(k.addLayer(m.$layer_markers),k.addLayer(m.$layer_new),k.addLayer(m.$layer_select));return!0};z=function(a,c){c.length?p(c):C()};A=function(a,c){var d=m.$marker_list[c].popup;r();d&&(d.toggle(),d.panIntoView(),h=d)};return{setMarkerPosition:function(a,
c,e){switch(a){case "opened":"create"===c?(a=k.getCenter(),n=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a.lon,a.lat)),m.$layer_new.addFeatures([n]),$.gevent.publish("feed-coord",{x:n.geometry.x.toFixed(0),y:n.geometry.y.toFixed(0)})):(m.$layer_new.removeAllFeatures(),n=null);q="report"===c?!0:!1;break;default:return!1}},configModule:function(c){feed.util.setConfigMap({input_map:c,settable_map:a.settable_map,config_map:a});return!0},initModule:function(a){var c=$("#mappanel");k=a;
e=c;g();$.gevent.subscribe(c,"feed-listchange",E);$.gevent.subscribe(c,"feed-setreport",x);$.gevent.subscribe(c,"feed-logout",F);$.gevent.subscribe(c,"feed-listhover",H);$.gevent.subscribe(c,"feed-removeslider",G);$.gevent.subscribe(c,"feed-search",z);$.gevent.subscribe(c,"feed-displayinfo",A)}}}();
